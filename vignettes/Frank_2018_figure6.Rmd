---
title: "Frank et al. (2018): Creating Figure Six (IVIVE)"
author: "John F. Wambaugh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Frank et al. (2018): Creating IVIVE Figure (Fig. 6)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

#Frank et al. (2018): Creating Figure Six    for the Manuscript
##Prepate for session
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(gdata)
library(httk)
library(ggplot2)
library(scales)
```
## Load the data:
```{r Frank2018data}
Frank2018invivo <- read.csv("Frank2018invivo.csv",stringsAsFactors=F)
chem.table <- Frank2018invivo
```


### This loops through each study design in the table and runs solve_pbtk:
```{R cssfun.u}
for (this.row in 1:dim(chem.table))
{
  this.cas <- chem.table[this.row,"Substance_CASRN"]
  if (tolower(chem.table[this.row,"Species"])=="rodent") 
  {  
    this.species <- "rat"
  } else if (tolower(chem.table[this.row,"Species"])=="rat") 
  {
    this.species <- "rat"
  } else if (tolower(chem.table[this.row,"Species"])=="human")
  {
    this.species <- "human"
  }
  else if (tolower(chem.table[this.row,"Species"])=="mouse") 
  {
    this.species <- "mouse"
  }
  else browser()
  if (chem.table[this.row,"Route"] %in% c("i.p.","s.c.","i.m.")) iv.dose =T
  else if (chem.table[this.row,"Route"]=="oral") iv.dose = F
  else browser()
  this.dose <- chem.table[this.row,"Dose"]
  this.days <- chem.table[this.row,"Days"]
# Make sure the dose units are in mg/kg body weight:
  if (regexpr("ug",chem.table[this.row,"Dose.Units"])!=-1) 
  {
    this.dose <- this.dose/1000
  }
  if (regexpr("/kg",chem.table[this.row,"Dose.Units"])==-1) 
  {
    this.dose <- this.dose/0.25
  }
# Here we run the HTTK PBPK Model:
  out <- solve_pbtk(chem.cas=this.cas,
           dose=this.dose,
           species=this.species,
           restrictive.clearance=F,
           days=this.days,
           iv.dose=iv.dose,
           default.to.human=T)
# Record the Cmax and the AUC:
  chem.table[this.row,"Cmax"] <- max(out[,"Cplasma"])
  chem.table[this.row,"AUC"] <- max(out[,"AUC"])
}
```

#Figure 6:
Comparison between predicted plasma levels for critical
concentrations and in vivo estimates from the httk model. For
those chemicals with 1) in vitro predicted critical concentrations,
2) in vivo studies indicating neurological effect, and 3)
available toxicokinetic data the time-integrated plasma concentration
(area under the curve or AUC) was predicted for the
LOEL associated with each chemical-specific study. The chemical-
specific prediction is indicated by the first four letters of
each chemicals name. There were two available studies for each
chemical. The identity (“perfect predictor”) line is indicated by
a solid black line, while the dashed lines indicate ten-fold above
and below perfect prediction. Because all in vitro treatments
were exposed for the same amount of time, the relationship
between nominal in vitro concentration and time-integrated
concentration is a constant.
```{R Frank2018.Fig6, eval=F}
Fig.AUC <- ggplot(data=chem.table) +
  geom_segment(color="grey",aes(x=AUC,y=Lower.95..CI,xend=AUC,yend=Higher.95..CI))+    
#  geom_point(aes(x=AUC,y=Critical.concentration,color="Chemical"))+ 
   geom_text(aes(x=AUC,y=Critical.concentration,label=Compound.abbrev,color=Chemical)) +
   scale_y_log10(label=scientific_10,limits=c(10^-7,100)) +
   scale_x_log10(label=scientific_10,limits=c(10^-7,100)) +
    annotation_logticks() + 
    geom_abline(slope=1, intercept=0) + 
    geom_abline(slope=1, intercept=1,linetype="dashed") + 
    geom_abline(slope=1, intercept=-1,linetype="dashed") + 
    xlab(expression(paste(italic("In vivo")," AUC estimated with HTTK (µM*day)"))) + 
    ylab(expression(paste(italic("In vitro")," predicted Critical Conc. (µM)"))) +
    scale_color_brewer(palette="Set2") + 
    theme_bw()  +
    theme(legend.position="bottom")
    
print(Fig.AUC)
```
