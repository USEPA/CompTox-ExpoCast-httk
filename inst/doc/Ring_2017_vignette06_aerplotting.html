<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Caroline Ring" />

<meta name="date" content="2018-04-05" />

<title>Ring et al. 2017 AER plotting</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Ring et al. 2017 AER plotting</h1>
<h4 class="author"><em>Caroline Ring</em></h4>
<h4 class="date"><em>2018-04-05</em></h4>



<p>This vignette contains the code necessary to create the AER (and OED, and exposure) heatmaps contained in the paper.</p>
<p>First, let’s load some useful packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">'data.table'</span>)
<span class="kw">library</span>(<span class="st">'gplots'</span>)
<span class="kw">library</span>(<span class="st">'ggplot2'</span>)
<span class="kw">library</span>(<span class="st">'httk'</span>)</code></pre></div>
<p>The vignette about model evaluations for subpopulations produced data files for each subpopulation, containing Css percentiles for each chemical in the HTTK data set. As described in the paper, for each chemical, an oral equivalent dose (OED) can be computed using the 95th percentile Css and a ToxCast AC50. The OED is an estimate of the dose that would induce bioactivity. Then, this OED can be compared to an estimate of exposure for the same chemical. The ratio of OED to exposure is called the activity-exposure ratio, or AER. if the AER is 1 or less, then exposure to this chemical may be high enough to induce bioactivity. if the AER is much more than 1, then there probably isn’t enough exposure to this chemical to cause bioactivity. The AER is thus an estimate of risk.</p>
<div id="computing-oeds" class="section level1">
<h1>Computing OEDs</h1>
<p>The first step is to read in the Css percentile data. We’ll go ahead and do this for all 10 subpopulations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Set some basic parameters for which data set to use</span>
poormetab &lt;-<span class="st"> </span><span class="ot">TRUE</span>
fup.censor &lt;-<span class="st"> </span><span class="ot">TRUE</span>
model &lt;-<span class="st"> '3compartmentss'</span>
<span class="co">#List all the subpopulations</span>
ExpoCast.groups &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'Total'</span>,
                     <span class="st">'Age.6.11'</span>,
                     <span class="st">'Age.12.19'</span>,
                     <span class="st">'Age.20.65'</span>,
                     <span class="st">'Age.GT65'</span>,
                     <span class="st">'BMIgt30'</span>,
                     <span class="st">'BMIle30'</span>,
                     <span class="st">'Males'</span>,
                     <span class="st">'Females'</span>,
                     <span class="st">'ReproAgeFemale'</span>)
<span class="co">#Read in data from each subpop and bind it all together</span>
<span class="co">#Use the direct-resampling data</span>
dat &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(ExpoCast.groups,
                        function(x) {
                          tmp &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">paste0</span>(<span class="st">'data/'</span>,
                                                <span class="kw">paste</span>(<span class="st">'allchems'</span>,
                                                      x,
                                                      <span class="st">'dr'</span>,
                                                      <span class="st">'poormetab'</span>,
                                                      poormetab,
                                                      <span class="st">'fup.censor'</span>,
                                                      fup.censor,
                                                      model,
                                                      <span class="st">&quot;FuptoFub&quot;</span>,
                                                      <span class="dt">sep=</span><span class="st">'_'</span>),
                                                <span class="st">'.Rdata'</span>))
                          tmp[, ExpoCast.group:<span class="er">=</span>x]
                          <span class="kw">return</span>(tmp)
                          }))</code></pre></div>
<p>Get the compound names that correspond to each CAS.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">chem.dt &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(httk::<span class="kw">get_cheminfo</span>(<span class="dt">info=</span><span class="kw">c</span>(<span class="st">'CAS'</span>, <span class="st">'Compound'</span>),
                                            <span class="dt">exclude.fub.zero=</span><span class="ot">FALSE</span>))
<span class="kw">setnames</span>(chem.dt, <span class="st">'CAS'</span>, <span class="st">'chemcas'</span>)
dat &lt;-<span class="st"> </span><span class="kw">merge</span>(dat, chem.dt, <span class="dt">by=</span><span class="st">'chemcas'</span>)</code></pre></div>
<p>Next, read in the ToxCast AC50 values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Column names are Assay Endpoint, CASRN, Activity Call, Q, AC50, Emax, Log AC50,</span>
<span class="co">#B, T, W, Data Type, Chemical Name.</span>
<span class="co">#Replace names containing spaces with names without spaces.</span>
<span class="kw">setnames</span>(tc.dt, 
         <span class="kw">c</span>(<span class="st">'Assay Endpoint'</span>, <span class="st">'AC 50'</span>, <span class="st">'Chemical Name'</span>,<span class="st">'Activity Call'</span>),
         <span class="kw">c</span>(<span class="st">'Assay.Endpoint'</span>, <span class="st">'AC50'</span>, <span class="st">'Chemical.Name'</span>, <span class="st">'Activity.Call'</span>))</code></pre></div>
<p>Keep only the rows of ToxCast data where the chemical was judged “Active” in an assay. Note: this will remove some chemicals entirely (if they were “Inactive” in all assays).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Keep only the rows with &quot;Active&quot; calls.</span>
tc.dt.sub &lt;-<span class="st"> </span>tc.dt[Activity.Call==<span class="st">&quot;Active&quot;</span>, 
                   .(Chemical.Name, CASRN, Assay.Endpoint, Activity.Call, AC50)]</code></pre></div>
<p>We summarize the distribution of AC50 values across all assays for each chemical by taking several percentiles.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ac50pct &lt;-<span class="st"> </span>tc.dt.sub[, 
                     <span class="kw">as.list</span>(<span class="kw">quantile</span>(AC50, 
                                      <span class="dt">probs=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,
                                              <span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,
                                              <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="dv">1</span>), 
                                      <span class="dt">na.rm=</span><span class="ot">TRUE</span>)),
                     keyby=CASRN]</code></pre></div>
<p>By default, the columns of <code>ac50pct</code> have names like “5%”, “10%”, etc. The “%” sign interferes with <code>data.table</code>’s syntax for referring to columns. So we replace names like “5%” with names like “AC50p5”, to indicate that the column contains AC50 values, percentile 5. To do this, use regular expressions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pctnames &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="kw">names</span>(ac50pct), <span class="dt">pattern=</span><span class="st">'%'</span>,<span class="dt">value=</span><span class="ot">TRUE</span>)
<span class="kw">setnames</span>(ac50pct,
         pctnames,
         <span class="kw">gsub</span>(<span class="dt">x=</span>pctnames, 
              <span class="dt">pattern=</span><span class="st">'(</span><span class="ch">\\</span><span class="st">d{1,3})</span><span class="ch">\\</span><span class="st">%'</span>, 
              <span class="dt">replacement=</span><span class="st">'AC50p</span><span class="ch">\\</span><span class="st">1'</span>, 
              <span class="dt">perl=</span><span class="ot">TRUE</span>) 
         )
<span class="co">#While we're at it, let's change the name of the CAS column to comport with its</span>
<span class="co">#name in the Css data</span>
<span class="kw">setnames</span>(ac50pct, <span class="st">'CASRN'</span>, <span class="st">'chemcas'</span>)</code></pre></div>
<p>Now we are ready to compute OEDs. Let’s compute one OED corresponding to each ToxCast AC50, using the 95th percentile Css for all of them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#merge in the AC50 percentile data</span>
m.tmp &lt;-<span class="st"> </span><span class="kw">merge</span>(dat,ac50pct,<span class="dt">by=</span><span class="st">'chemcas'</span>)
<span class="co">#find column names beginning with &quot;AC50&quot;</span>
<span class="co">#to use for naming the OED columns</span>
ac50names &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="dt">x=</span><span class="kw">names</span>(m.tmp),
                  <span class="dt">pattern=</span><span class="st">'^AC50'</span>, 
                  <span class="dt">value=</span><span class="ot">TRUE</span>,
                  <span class="dt">perl=</span><span class="ot">TRUE</span>)
<span class="co">#Compute OEDs</span>
m.tmp[, (<span class="kw">paste</span>(<span class="st">'oed'</span>, ac50names, <span class="dt">sep=</span><span class="st">'.'</span>)):<span class="er">=</span><span class="kw">lapply</span>(.SD,
                                                   function(x) x/m.tmp[, css95]),
      .SDcols=ac50names]</code></pre></div>
<p>For another view of the data, let’s compute one OED corresponding to each Css percentile, using the 10th percentile AC50 value for all of them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#merge in the AC50 percentile data</span>
m.css &lt;-<span class="st"> </span><span class="kw">merge</span>(dat,ac50pct,<span class="dt">by=</span><span class="st">'chemcas'</span>)
<span class="co">#find column names beginning with &quot;css&quot;</span>
<span class="co">#to use for naming the OED columns</span>
cssnames &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="dt">x=</span><span class="kw">names</span>(m.css),
                  <span class="dt">pattern=</span><span class="st">'^css'</span>, 
                  <span class="dt">value=</span><span class="ot">TRUE</span>,
                  <span class="dt">perl=</span><span class="ot">TRUE</span>)
<span class="co">#Compute OEDs</span>
m.css[, (<span class="kw">paste</span>(<span class="st">'oed'</span>, cssnames, <span class="dt">sep=</span><span class="st">'.'</span>)):<span class="er">=</span><span class="kw">lapply</span>(.SD,
                                                   function(x) m.css[, AC50p10]/x),
      .SDcols=cssnames]</code></pre></div>
</div>
<div id="exposure-data" class="section level1">
<h1>Exposure data</h1>
<p>Bringing in the NHANES exposure inference data, onlyp, let’s compute the “worst-case” AER: using <code>oed.css95</code> (the OED based on the 95th percentile Css value and 10th percentile AC50) and <code>exposure.median.95CI.upper</code> (the upper bound of the 95% confidence interval on the median exposure estimate).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Merge in the exposure data</span>
m.tmp &lt;-<span class="st"> </span><span class="kw">merge</span>(m.tmp,onlyp,
               <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;chemcas&quot;</span>, <span class="st">&quot;ExpoCast.group&quot;</span>))
m.css &lt;-<span class="st"> </span><span class="kw">merge</span>(m.css,onlyp,
               <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;chemcas&quot;</span>, <span class="st">&quot;ExpoCast.group&quot;</span>))
<span class="co">#Compute AER</span>
m.tmp[, aer:<span class="er">=</span>oed.AC50p10/exposure.median.95CI.upper]
m.css[, aer:<span class="er">=</span>oed.css95/exposure.median.95CI.upper]</code></pre></div>
</div>
<div id="plotting-oed-vs.exposure-boxplots" class="section level1">
<h1>Plotting OED vs. exposure boxplots</h1>
<p>First, take care of some housekeeping. Replace a couple of very long chemical names with shorter names, for better display.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Shorten a couple of compound names for display</span>
m.tmp[Compound==<span class="st">&quot;O-ethyl o-(p-nitrophenyl) phenylphosphonothioate&quot;</span>,
      Compound:<span class="er">=</span><span class="st">&quot;Phosphonothioic acid&quot;</span>]
m.tmp[Compound==<span class="st">&quot;4-(1,1,3,3-tetramethylbutyl)phenol&quot;</span>,
      Compound:<span class="er">=</span><span class="st">&quot;p-tert-Octylphenol&quot;</span>]
m.css[Compound==<span class="st">&quot;O-ethyl o-(p-nitrophenyl) phenylphosphonothioate&quot;</span>,
      Compound:<span class="er">=</span><span class="st">&quot;Phosphonothioic acid&quot;</span>]
m.css[Compound==<span class="st">&quot;4-(1,1,3,3-tetramethylbutyl)phenol&quot;</span>,
      Compound:<span class="er">=</span><span class="st">&quot;p-tert-Octylphenol&quot;</span>]</code></pre></div>
<p>For this plot, show only the total population.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Plot only for the total population</span>
m.Total &lt;-<span class="st"> </span>m.tmp[ExpoCast.group==<span class="st">'Total'</span>,]
m.css.Total &lt;-<span class="st"> </span>m.css[ExpoCast.group==<span class="st">'Total'</span>,]</code></pre></div>
<p>By default, <code>ggplot2</code> will plot the chemicals in alphabetical order. Instead, let’s order them from smallest to largest AER. To do this, we need to sort the data table, then create a chemical names <em>factor</em> variable, with levels given by the AER-sorted order.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Order the chemicals by AER</span>
<span class="kw">setorder</span>(m.Total, aer)
<span class="co">#Get a list of ordered chemical names so that ggplot2 will plot them in the </span>
<span class="co">#right order (as opposed to its default alphabetical order)</span>
cpdlevels &lt;-<span class="st"> </span>m.Total[, Compound]
m.Total[, Compound.factor:<span class="er">=</span><span class="kw">factor</span>(Compound, <span class="dt">levels=</span>cpdlevels)]
m.tmp[, Compound.factor:<span class="er">=</span><span class="kw">factor</span>(Compound, <span class="dt">levels=</span>cpdlevels)]

<span class="co">#Order the chemicals by AER</span>
<span class="kw">setorder</span>(m.css.Total, aer)
<span class="co">#Get a list of ordered chemical names so that ggplot2 will plot them in the </span>
<span class="co">#right order (as opposed to its default alphabetical order)</span>
cpdlevels &lt;-<span class="st"> </span>m.css.Total[, Compound]
m.css.Total[, Compound.factor:<span class="er">=</span><span class="kw">factor</span>(Compound, <span class="dt">levels=</span>cpdlevels)]
m.css[, Compound.factor:<span class="er">=</span><span class="kw">factor</span>(Compound, <span class="dt">levels=</span>cpdlevels)]</code></pre></div>
<p>Now, we’re ready to start the plot. First, make the OED boxes, ranging from 25th percentile AC50 to 75th percentile AC50, with a crossbar at median AC50.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Start the plot: first, make the OED boxes, ranging between 25th and 75th </span>
<span class="co">#percentile AC50, with a crossbar at median AC50.</span>
p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>m.Total) +
<span class="st">  </span><span class="kw">geom_crossbar</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,<span class="dt">y=</span>oed.AC50p50,
                    <span class="dt">ymin=</span>oed.AC50p25,<span class="dt">ymax=</span>oed.AC50p75))</code></pre></div>
<p>Add the upper whisker (to OED for 90th percentile AC50) and the lower whisker (to OED for 10th percentile OED).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p +
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,
                     <span class="dt">ymin=</span>oed.AC50p75,
                     <span class="dt">ymax=</span>oed.AC50p90))+
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,
                     <span class="dt">ymin=</span>oed.AC50p10,
                     <span class="dt">ymax=</span>oed.AC50p25))  </code></pre></div>
<p>And add points above and below the box-and-whisker plots, to represent OEDs for 95th percentile AC50 values, and for 5th percentile AC50 values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>oed.AC50p95)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>oed.AC50p5))</code></pre></div>
<p>Finally, add the exposure box plots, ranging between the upper and lower bounds on the 95% confidence interval for the median, with a crossbar at the median.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p +
<span class="st">  </span><span class="kw">geom_crossbar</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>exposure.median,
                    <span class="dt">ymin=</span>exposure.median.95CI.lower,
                    <span class="dt">ymax=</span>exposure.median.95CI.upper),
                <span class="dt">color=</span><span class="st">'#FC8D62'</span>) </code></pre></div>
<p>Set the OED/exposure axis (vertical axis) to a log scale, and do some tweaking of the plot labels to make things more readable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span>p +
<span class="st">  </span><span class="kw">scale_y_log10</span>()+
<span class="st">  </span><span class="kw">theme_bw</span>()+
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">60</span>, 
                                   <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.ticks.x =</span> <span class="kw">element_line</span>(<span class="dt">size=</span><span class="fl">0.01</span>, <span class="dt">color =</span> <span class="st">'grey50'</span>),
        <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.2</span>)),
        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.2</span>))) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">'Compound'</span>,
       <span class="dt">y=</span><span class="st">'OED or Inferred Exposure, </span><span class="ch">\n</span><span class="st"> mg/kg/day'</span>)</code></pre></div>
<p>Then save the plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggsave</span>(<span class="dt">plot=</span>p, <span class="dt">filename=</span><span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
                               <span class="kw">paste</span>(<span class="st">'oed_exposure_plot'</span>,model,
                                     <span class="st">'poormetab'</span>, poormetab,
                                     <span class="st">'fupcensor'</span>, fup.censor,
                                     <span class="st">&quot;FuptoFub&quot;</span>,
                                     <span class="st">'Total'</span>, <span class="st">'OEDdistoverAC50'</span>, 
                                     <span class="dt">sep=</span><span class="st">'_'</span>),<span class="st">'.pdf'</span>),
       <span class="dt">width=</span><span class="dv">14</span>,<span class="dt">height=</span><span class="fl">8.5</span>)
<span class="kw">print</span>(p)</code></pre></div>
<p>Then let’s do it again for the OEDs computed for different Css percentiles. Remember that the OEDs are inversely proportional to Css.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>m.css.Total) +
<span class="st">  </span><span class="kw">geom_crossbar</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,<span class="dt">y=</span>oed.css50,
                    <span class="dt">ymin=</span>oed.css75,
                    <span class="dt">ymax=</span>oed.css25))+
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,
                     <span class="dt">ymin=</span>oed.css25,
                     <span class="dt">ymax=</span>oed.css10))+
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor,
                     <span class="dt">ymin=</span>oed.css90,
                     <span class="dt">ymax=</span>oed.css75)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>oed.css5)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>oed.css95))+
<span class="st">  </span><span class="kw">geom_crossbar</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Compound.factor, <span class="dt">y=</span>exposure.median,
                    <span class="dt">ymin=</span>exposure.median.95CI.lower,
                    <span class="dt">ymax=</span>exposure.median.95CI.upper),
                <span class="dt">color=</span><span class="st">'#FC8D62'</span>)+
<span class="st">  </span><span class="kw">scale_y_log10</span>()+
<span class="st">  </span><span class="kw">theme_bw</span>()+
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">60</span>, 
                                   <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;grey50&quot;</span>),
        <span class="dt">axis.ticks.x =</span> <span class="kw">element_line</span>(<span class="dt">size=</span><span class="fl">0.01</span>, <span class="dt">color =</span> <span class="st">'grey50'</span>),
        <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.2</span>)),
        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.2</span>))) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">'Compound'</span>,
       <span class="dt">y=</span><span class="st">'OED or Inferred Exposure, </span><span class="ch">\n</span><span class="st"> mg/kg/day'</span>)
<span class="kw">ggsave</span>(<span class="dt">plot=</span>p, <span class="dt">filename=</span><span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
                               <span class="kw">paste</span>(<span class="st">'oed_exposure_plot'</span>,model,
                                     <span class="st">'poormetab'</span>, poormetab,
                                     <span class="st">'fupcensor'</span>, fup.censor,
                                     <span class="st">&quot;FuptoFub&quot;</span>,
                                     <span class="st">'Total'</span>, <span class="st">'OEDdistoverCss'</span>, 
                                     <span class="dt">sep=</span><span class="st">'_'</span>),<span class="st">'.pdf'</span>),
       <span class="dt">width=</span><span class="dv">14</span>,<span class="dt">height=</span><span class="fl">8.5</span>)
<span class="kw">print</span>(p)</code></pre></div>
</div>
<div id="plotting-heatmaps" class="section level1">
<h1>Plotting heatmaps</h1>
<p>Heatmaps will let us visualize the magnitude of the difference in AER, OED, and exposure, between each subpopulation and the total population, for each chemical.</p>
<div id="plotting-aer-heatmaps" class="section level2">
<h2>Plotting AER heatmaps</h2>
<p>To visualize the difference in AER from the total population for each group, it’s probably best to look at the order-of-magnitude differences. That is, if AER for the total population for a given chemical is 1e6, and AER for the same chemical for the Age.6.11 population is 1, then AER for Age.6.11 is 6 orders of magnitude less than AER for the total population.</p>
<p>To compute this numerically, compute the difference in the log10 AERs between each subpopulation and the total population. In the example above, log10 AER for Age.6.11 is log10(1) = 0, and log10 AER for the total population is log10(1e6) = 6. So the difference is 0 - 6 = -6.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Compute difference in log AERs:</span>
<span class="co">#log AER group - log AER Total</span>
m.tmp[, logAER.diff:<span class="er">=</span><span class="kw">log10</span>(aer)-
<span class="st">        </span>m.tmp[ExpoCast.group==<span class="st">'Total'</span>, <span class="kw">log10</span>(aer)],
      by=ExpoCast.group]
<span class="co">#if logAER.diff is positive, then log AER group &gt; log AER Total</span>
<span class="co">#if logAER.diff is negative, then log AER group &lt; log AER Total</span></code></pre></div>
<p>To create the heatmap, first cast the data table into matrix form.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Cast into matrix</span>
m.mat &lt;-<span class="st"> </span>reshape2::<span class="kw">acast</span>(m.tmp[,
                               .(Compound.factor, ExpoCast.group, logAER.diff)],
                         Compound.factor~ExpoCast.group,
                         <span class="dt">value.var=</span><span class="st">'logAER.diff'</span>)</code></pre></div>
<p>To visualize differences above and below some mean value, it’s usually best to use a diverging colormap, like those in <a href="http://colorbrewer2.org">ColorBrewer 2</a>. Unfortunately, <code>heatmap.2</code> — the function we’ll use to create the heatmap plots — doesn’t have a built-in way to properly interpolate the diverging color palettes provided by, e.g., <code>RColorBrewer</code>. So we have to set up a function to do the interpolation. This function is a minor adaptation of some code provided in <a href="http://stackoverflow.com/a/10986203">a Stack Overflow answer by Josh O’Brien</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Use a diverging color palette</span>
<span class="co">#Based on http://stackoverflow.com/a/10986203 by Josh O'Brien</span>
diverge.color &lt;-<span class="st"> </span>function(data,<span class="dt">pal_choice=</span><span class="st">&quot;RdBu&quot;</span>,<span class="dt">Thresh=</span><span class="dv">0</span>){
  <span class="co">#use 100 colors total, and divide the data into 100 bins</span>
  <span class="co">#meaning that the &quot;halfway&quot; color is bin 50</span>
  nHalf&lt;-<span class="dv">50</span> 
  Min &lt;-<span class="st"> </span><span class="kw">min</span>(data,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)
  Max &lt;-<span class="st"> </span><span class="kw">max</span>(data,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)
  pal&lt;-RColorBrewer::<span class="kw">brewer.pal</span>(<span class="dt">n=</span><span class="dv">11</span>,pal_choice)
  <span class="co">#interpolate gradient between the first two colors</span>
  rc1&lt;-<span class="kw">colorRampPalette</span>(<span class="dt">colors=</span><span class="kw">c</span>(pal[<span class="dv">1</span>],pal[<span class="dv">2</span>]), <span class="dt">space=</span><span class="st">&quot;Lab&quot;</span>)(<span class="dv">10</span>) 
  <span class="co">#interpolate gradient between each succeeding pair of colors</span>
  for(i in <span class="dv">2</span>:<span class="dv">10</span>){
    tmp&lt;-<span class="kw">colorRampPalette</span>(<span class="dt">colors=</span><span class="kw">c</span>(pal[i],pal[i<span class="dv">+1</span>]), <span class="dt">space=</span><span class="st">&quot;Lab&quot;</span>)(<span class="dv">10</span>) 
    rc1&lt;-<span class="kw">c</span>(rc1,tmp)
    }
  <span class="co">#calculate the data breaks</span>
  rb1 &lt;-<span class="st"> </span><span class="kw">seq</span>(Min, Thresh, <span class="dt">length.out=</span>nHalf<span class="dv">+1</span>)
  rb2 &lt;-<span class="st"> </span><span class="kw">seq</span>(Thresh, Max, <span class="dt">length.out=</span>nHalf<span class="dv">+1</span>)[-<span class="dv">1</span>]
  rampbreaks &lt;-<span class="st"> </span><span class="kw">c</span>(rb1, rb2)
  cuts &lt;-<span class="st"> </span>classInt::<span class="kw">classIntervals</span>(data, <span class="dt">style=</span><span class="st">&quot;fixed&quot;</span>, <span class="dt">fixedBreaks=</span>rampbreaks)
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">cuts=</span>cuts,<span class="dt">rc1=</span>rc1))
  }</code></pre></div>
<p>Then we use the <code>diverge.color</code> function to generate the appropriate colors and breaks for the AER data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">brks &lt;-<span class="st"> </span><span class="kw">diverge.color</span>(<span class="dt">data=</span><span class="kw">c</span>(<span class="kw">as.vector</span>(m.mat), -<span class="fl">0.8</span>,<span class="fl">0.8</span>),<span class="dt">pal_choice=</span><span class="st">'RdBu'</span>)
breaksv &lt;-<span class="st"> </span>brks$cuts[[<span class="st">'brks'</span>]]</code></pre></div>
<p>Then we generate a matrix of character strings so that we can label the single cell with missing data for the AER and exposure heatmaps.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">notemat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="kw">length</span>(m.mat)), <span class="dt">nrow=</span><span class="kw">nrow</span>(m.mat), <span class="dt">ncol=</span><span class="kw">ncol</span>(m.mat))
notemat[<span class="kw">which</span>(<span class="kw">is.na</span>(m.mat), <span class="dt">arr.ind=</span>T)] &lt;-<span class="st"> 'NA'</span></code></pre></div>
<p>For ease of use later, define a list of plotting options to use for all the heatmap.2 calls.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hm_args &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Rowv=</span><span class="ot">FALSE</span>, <span class="co">#don't reorder rows</span>
                 <span class="dt">dendrogram =</span> <span class="st">'column'</span>,
                 <span class="dt">col=</span>brks$rc1,
                 <span class="dt">breaks=</span>breaksv,
                 <span class="dt">na.col =</span> <span class="st">'#FFFF33'</span>,
                 <span class="dt">trace=</span><span class="st">'none'</span>,
                 <span class="dt">margin=</span><span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">8</span>),
                 <span class="dt">key.xlab=</span><span class="kw">expression</span>(<span class="kw">paste</span>(Delta, <span class="st">'log(AER), Group - Total'</span>)),
                 <span class="dt">key.ylab=</span><span class="st">&quot;Count&quot;</span>,
                 <span class="dt">key.title=</span><span class="ot">NA</span>,
                 <span class="dt">srtCol=</span><span class="dv">40</span>,
                 <span class="dt">adjCol=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),
                 <span class="dt">denscol=</span><span class="st">'black'</span>,
                 <span class="dt">cellnote =</span> notemat,
                 <span class="dt">notecex=</span><span class="fl">0.7</span>,
                 <span class="dt">notecol=</span><span class="st">'black'</span>,
                 <span class="dt">cexRow=</span><span class="fl">0.8</span>)</code></pre></div>
<p>Finally, we actually plot the heatmap!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pdf</span>(<span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
           <span class="kw">paste</span>(<span class="st">'deltaAERheatmap'</span>,
                 <span class="st">'model'</span>,model,
                 <span class="st">'poormetab'</span>,poormetab,
                 <span class="st">'fupcensor'</span>,fup.censor, 
                 <span class="st">&quot;FuptoFub&quot;</span>,
                 <span class="st">'test'</span>,
                 <span class="dt">sep=</span><span class="st">'_'</span>), <span class="st">'.pdf'</span>), <span class="dt">pointsize=</span><span class="dv">10</span>)
hm1 &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
               <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat),
                      hm_args))
<span class="kw">dev.off</span>()
hm1 &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
               <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat),
                      hm_args))</code></pre></div>
<p>We also want to plot a version with a colorbar to the left of the heatmap, illustrating the orders of magnitude of the AERs in the Total population.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m.Total[, aer.ordermag:<span class="er">=</span><span class="kw">findInterval</span>(<span class="kw">log10</span>(aer), <span class="dv">0</span>:<span class="dv">8</span>)]
cols &lt;-<span class="st"> </span>RColorBrewer::<span class="kw">brewer.pal</span>(<span class="dt">name=</span><span class="st">'Set3'</span>, <span class="dt">n=</span><span class="dv">9</span>)
colvect &lt;-<span class="st"> </span>cols[m.Total[,aer.ordermag<span class="dv">+1</span>]]
<span class="kw">pdf</span>(<span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
           <span class="kw">paste</span>(<span class="st">'deltaAERheatmap'</span>,
                 <span class="st">'model'</span>,model,
                 <span class="st">'poormetab'</span>,poormetab,
                 <span class="st">'fupcensor'</span>,fup.censor, 
                 <span class="st">&quot;FuptoFub&quot;</span>,
                 <span class="st">'bigger'</span>, <span class="st">'annotated'</span>,
                 <span class="dt">sep=</span><span class="st">'_'</span>), <span class="st">'.pdf'</span>),
    <span class="dt">pointsize =</span> <span class="dv">10</span>)
hm1.ann &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
                   <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat,
                               <span class="dt">RowSideColors=</span>colvect),
                          hm_args))
<span class="kw">dev.off</span>()
hm1.ann &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
                   <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat,
                               <span class="dt">RowSideColors=</span>colvect),
                          hm_args))</code></pre></div>
</div>
<div id="plotting-oed-heatmap" class="section level2">
<h2>Plotting OED heatmap</h2>
<p>We follow a similar procedure for the OED heatmap. First, compute differences in the log10 OEDs for each subpopulation from the total population.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Likewise, compute differences in log OEDs</span>
m.tmp[, logOED.diff:<span class="er">=</span><span class="kw">log10</span>(oed.AC50p10)-
<span class="st">        </span>m.tmp[ExpoCast.group==<span class="st">'Total'</span>, <span class="kw">log10</span>(oed.AC50p10)],
      by=ExpoCast.group]</code></pre></div>
<p>Then construct the matrix in the same way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m.mat2 &lt;-<span class="st"> </span>reshape2::<span class="kw">acast</span>(m.tmp[,
                                .(Compound.factor, ExpoCast.group, logOED.diff)],
                          Compound.factor~ExpoCast.group,
                          <span class="dt">value.var=</span><span class="st">'logOED.diff'</span>)</code></pre></div>
<p>Generate the diverging colormap for the OED data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">brks &lt;-<span class="st"> </span><span class="kw">diverge.color</span>(<span class="dt">data=</span><span class="kw">c</span>(<span class="kw">as.vector</span>(m.mat2), -<span class="fl">0.8</span>,<span class="fl">0.8</span>), <span class="dt">pal_choice=</span><span class="st">'RdBu'</span>)
breaksv &lt;-<span class="st"> </span>brks$cuts[[<span class="st">'brks'</span>]]</code></pre></div>
<p>Put the subpopulations in the same order as for the AER heatmap.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m.mat2 &lt;-<span class="st"> </span>m.mat2[, hm1$colInd]</code></pre></div>
<p>And finally, plot the heatmap.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hm_args_oed &lt;-<span class="st"> </span>hm_args
hm_args_oed$col &lt;-<span class="st"> </span>brks$rc1
hm_args_oed$breaks &lt;-<span class="st"> </span>breaksv
hm_args_oed$key.xlab&lt;-<span class="kw">expression</span>(<span class="kw">paste</span>(Delta, <span class="st">'log(OED), Group - Total'</span>))
hm_args_oed$Colv &lt;-<span class="st"> </span><span class="ot">FALSE</span>
hm_args_oed$cellnote &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">pdf</span>(<span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
           <span class="kw">paste</span>(<span class="st">'deltaOEDheatmap'</span>,
                 <span class="st">'model'</span>,model,
                 <span class="st">'poormetab'</span>,poormetab,
                 <span class="st">'fupcensor'</span>,fup.censor,
                 <span class="st">&quot;FuptoFub&quot;</span>, 
                 <span class="dt">sep=</span><span class="st">'_'</span>),
           <span class="st">'.pdf'</span>), <span class="dt">pointsize=</span><span class="dv">10</span>)
<span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
        <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat2),
               hm_args_oed))
<span class="kw">dev.off</span>()
<span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
        <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat2),
               hm_args_oed))</code></pre></div>
</div>
<div id="exposure-heatmap" class="section level2">
<h2>Exposure heatmap</h2>
<p>The procedure is the same for the exposure data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#And likewise, compute differences in log exposures</span>
m.tmp[, logexposure.diff:<span class="er">=</span><span class="kw">log10</span>(exposure.median.95CI.upper)-
<span class="st">        </span>m.tmp[ExpoCast.group==<span class="st">'Total'</span>, <span class="kw">log10</span>(exposure.median.95CI.upper)],
      by=ExpoCast.group]
<span class="co">#Cast into matrix</span>
m.mat3 &lt;-<span class="st"> </span>reshape2::<span class="kw">acast</span>(m.tmp[,
                      .(Compound.factor, ExpoCast.group, logexposure.diff)],
                Compound.factor~ExpoCast.group,
                <span class="dt">value.var=</span><span class="st">'logexposure.diff'</span>)
<span class="co">#Put columns in same order as for AER heatmap</span>
m.mat3 &lt;-<span class="st"> </span>m.mat3[,hm1$colInd]
<span class="co">#Make cell labeling matrix</span>
notemat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="kw">length</span>(m.mat3)), <span class="dt">nrow=</span><span class="kw">nrow</span>(m.mat3), <span class="dt">ncol=</span><span class="kw">ncol</span>(m.mat3))
notemat[<span class="kw">which</span>(<span class="kw">is.na</span>(m.mat3), <span class="dt">arr.ind=</span>T)] &lt;-<span class="st"> 'NA'</span>
<span class="co">#Set up diverging colormap</span>
brks &lt;-<span class="st"> </span><span class="kw">diverge.color</span>(<span class="dt">data=</span><span class="kw">c</span>(<span class="kw">as.vector</span>(m.mat3),-<span class="fl">0.8</span>,<span class="fl">0.8</span>), <span class="dt">pal_choice=</span><span class="st">'RdBu'</span>)
breaksv &lt;-<span class="st"> </span>brks$cuts[[<span class="st">'brks'</span>]]

hm_args_exp &lt;-<span class="st"> </span>hm_args
hm_args_exp$col &lt;-<span class="st"> </span><span class="kw">rev</span>(brks$rc1)
hm_args_exp$breaks &lt;-<span class="st"> </span>breaksv
hm_args_exp$key.xlab&lt;-<span class="kw">expression</span>(<span class="kw">paste</span>(Delta, <span class="st">'log(exposure), Group - Total'</span>))
hm_args_exp$Colv &lt;-<span class="st"> </span><span class="ot">FALSE</span>
hm_args_exp$cellnote &lt;-<span class="st"> </span>notemat
<span class="co">#And make the plot</span>
<span class="kw">pdf</span>(<span class="kw">paste0</span>(<span class="st">'pdf_figures/'</span>,
           <span class="kw">paste</span>(<span class="st">'deltaexposureheatmap'</span>,
                 <span class="st">'model'</span>, model,
                 <span class="st">'poormetab'</span>, poormetab,
                 <span class="st">'fupcensor'</span>, fup.censor, 
                 <span class="st">&quot;FuptoFub&quot;</span>, 
                 <span class="dt">sep=</span><span class="st">'_'</span>),
           <span class="st">'.pdf'</span>), <span class="dt">pointsize=</span><span class="dv">10</span>)
<span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
        <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat3),
               hm_args_exp))
<span class="kw">dev.off</span>()
<span class="kw">do.call</span>(<span class="dt">what=</span>heatmap<span class="fl">.2</span>,
        <span class="dt">args=</span><span class="kw">c</span>(<span class="kw">list</span>(<span class="dt">x=</span>m.mat3),
               hm_args_exp))</code></pre></div>
<p>Finally, write the OED, exposure, and AER data in tabular form.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setorder</span>(m.tmp, ExpoCast.group, aer)
<span class="kw">write.table</span>(m.tmp[, .(Compound, ExpoCast.group, css95, oed.AC50p10, exposure.median.95CI.upper, aer)], <span class="dt">file=</span><span class="st">&quot;data/aer_data_FuptoFub.txt&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
