---
title: "Pearce et al. (2017): Updated v79i04.R Examples"
author: "Robert G Pearce, R Woodrow Setzer, Cory L Strope, Nisha S Sipes, and John F Wambaugh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{f) Kapraun et al. (2022): Creating All Figures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
wambaugh.john@epa.gov

from "httk: R Package for High-Throughput Toxicokinetics"

Robert G Pearce, R Woodrow Setzer, Cory L Strope, Nisha S Sipes, and John F Wambaugh

J Stat Softw. 2017 Jul 17; 79(4): 1-26.

https://doi.org/10.18637%2Fjss.v079.i04

## Abstract

Thousands of chemicals have been profiled by high-throughput screening programs 
such as ToxCast and Tox21; these chemicals are tested in part because most of 
them have limited or no data on hazard, exposure, or toxicokinetics. 
Toxicokinetic models aid in predicting tissue concentrations resulting from 
chemical exposure, and a "reverse dosimetry" approach can be used to predict 
exposure doses sufficient to cause tissue concentrations that have been 
identified as bioactive by high-throughput screening. We have created four 
toxicokinetic models within the R software package httk. These models are 
designed to be parameterized using high-throughput in vitro data (plasma 
protein binding and hepatic clearance), as well as structure-derived 
physicochemical properties and species-specific physiological data. The package 
contains tools for Monte Carlo sampling and reverse dosimetry along with 
functions for the analysis of concentration vs. time simulations. The package 
can currently use human in vitro data to make predictions for 553 chemicals in 
humans, rats, mice, dogs, and rabbits, including 94 pharmaceuticals and 415 
ToxCast chemicals. For 67 of these chemicals, the package includes rat-specific 
in vitro data. This package is structured to be augmented with additional 
chemical data as they become available. Package httk enables the inclusion of 
toxicokinetics in the statistical analysis of chemicals undergoing
high-throughput screening.

## HTTK Version

This vignette was created with httk v1.7. Although we attempt to maintain 
backward compatibility, if you encounter issues with the latest release of httk
and cannot easily address the changes, historical versions of httk are 
available from: https://cran.r-project.org/src/contrib/Archive/httk/

## Prepare for session
```{r}
knitr::opts_chunk$set(collapse = TRUE, comment = '#>')
options(rmarkdown.html_vignette.check_title = FALSE)
```

### Load the relevant libraries
If you get the message "Error in library(X) : there is no package called 'X'"
then you will need to install that package: 

From the R command prompt:

install.packages("X")

Or, if using RStudio, look for 'Install Packages' under 'Tools' tab.
```{r load_packages, eval = TRUE}
# Clear the memory:
rm(list=ls()) 
#
#
# Setup
#
#
#library(readxl)
library(ggplot2)
library(httk)

## To check if the version installed is 1.7:
packageVersion("httk")  >= "1.7"
```


## Examples
To get a list of parameters for the pbtk model of triclosan in a rat:
```{r pbtk_parameters, eval = TRUE}
# Don't have all the parameters we need for triclosan in the rat:
parameters <- try(parameterize_pbtk(chem.name = "triclosan", species = "rat"))
# So we use "default.to.human = TRUE":
parameters <- parameterize_pbtk(chem.name = "triclosan", 
                                species = "rat", 
                                default.to.human = TRUE)
```

To change the $$f_{up}$$ in the previous parameters list to 0.001 from the
human value of 0.003044 and use it in a simulation of the PBTK model for
a single dose of 1 mg/kg BW of Triclosan in a rat:
```{r use)pbtk_parameters, eval = TRUE}
parameters["Funbound.plasma"] <- 0.1
out <- solve_pbtk(parameters = parameters)
```


## Table making example: 

In the example below, setting model to "pbtk"
in get cheminfo removes the chemicals from the list with $$f_{up}$$ below
the limit of detection which have been set to zero because the
model uses partition coefficients that are calculated with
$$f_{up}$$. However, we could include all chemicals that work with the
models without partition coefficients by using the default option of
"3compartmentss" or setting exclude.fup.zero to false, and $$f_{up}$$
would then automatically be set to 0.005.
```{r make_Css_table, eval = FALSE}
table <- NULL
for (this.cas in intersect(get_cheminfo(model = "pbtk"), get_wetmore_cheminfo())) {
    this.row <- as.data.frame(this.cas)
    this.row <- cbind(this.row,
                      as.data.frame(calc_analytic_css(chem.cas = this.cas,
                                                      model = "pbtk",
                                                      output.units = "mg/L",
                                                      suppress.messages=TRUE)))
    this.row <- cbind(this.row,
                      as.data.frame(get_wetmore_css(chem.cas = this.cas,
                                                    which.quantile = 0.50,
                                                      suppress.messages=TRUE)))
    this.row <- cbind(this.row,
                      as.data.frame(calc_mc_css(chem.cas = this.cas,
                                                which.quantile = 0.50,
                                                      suppress.messages=TRUE)))
    table <- rbind(table, this.row)
}
colnames(table) <- c("CAS", "PBTK", "Wetmore", "MC")
```

## Plotting example.

To see how Css resulting from discrete dosing deviates from the
average steady state concentration, we can make a plot with ggplot2
that includes a horizontal line through the y axis at the predicted
Css for oral infusion dosing (Figure 2).
```{r plot_examples, eval = TRUE}
out <- solve_pbtk(chem.name = "Bisphenol A", 
                  days = 50, 
                  doses.per.day = 3,
                  daily.dose=1)
plot.data <- as.data.frame(out)
css <- calc_analytic_css(chem.name = "Bisphenol A")
c.vs.t <- ggplot(plot.data, aes(time, Cplasma)) +
    geom_line() + geom_hline(yintercept = css) +
    ylab("Plasma Concentration (uM)") + xlab("Day") +
    theme(axis.text = element_text(size = 16),
          axis.title = element_text(size = 16),
          plot.title = element_text(size = 17, hjust=0.5)) +
    ggtitle("Bisphenol A")
print(c.vs.t)
```

## TK Study Summary Statistics
To calculate the peak statistics for all chemicals simulated for 10
days at 1 mg/kg BW/day with 3 doses per day.
Note that the function calc_stats was renamed calc_tk_stats in a later release
of "httk".
```{r stats_example1, eval = FALSE}
all.peak.stats <- calc_stats(days = 10, doses.per.day = 3, stats = "peak")
```
A list containing
the AUC, peak, and mean for a single 1 mg dose of Triclosan over 10
days, we have:
```{r stats_example2, eval = TRUE}
triclosan.stats <- calc_stats(days = 10, chem.name = "triclosan")
```

## Steady-state Plasma Concentration
Below are examples of two functions,comparing the medians of
the Wetmore data in humans for 1 mg/kg BW/day of Bisphenol A with
the calc_mc_css simulation with probability distributions
containing a third of the standard deviation, half the limit of
detection for $$f_{up}$$, and the same number of samples of the
parameters used in [Wetmore et al. (2012)](https://doi.org/10.1093/toxsci/kfr254). 
We use make use of the default
Monte Carlo sampler by setting httkpop=FALSE to turn off
httk-pop ([Ring et al., 2017](https://doi.org/10.1016/j.envint.2017.06.004)) and 
invitrouv=FALSE to turn off uncertainty/variability
for the *in vitro* parameters ([Wambaugh et al., 2019](https://doi.org/10.1093/toxsci/kfz205)). 
We use set.seed to get the same 
random sequence of numbers for the Monte Carlo sampler every time.
Note that the function get_wetmore_css was renamed get_lit_css in a later release
of "httk".
```{r css_examples, eval = TRUE}
get_wetmore_css(chem.cas = "80-05-7", daily.dose = 1,
                which.quantile = 0.5, output.units = "uM")
set.seed(654321)
calc_mc_css(chem.cas = "80-05-7", daily.dose = 1, which.quantile = 0.5,
            censored.params = list(Funbound.plasma = list(cv = 0.1, lod = 0.005)),
            vary.params = list(BW = 0.15, Vliverc = 0.15, Qgfrc = 0.15,
                               Qtotal.liverc = 0.15, million.cells.per.gliver = 0.15,
                               Clint = 0.15),
            output.units = "uM", 
            samples = 1000,
            httkpop=FALSE,
            invitrouv=FALSE)
```
Both httk-pop and *in vitro* uncertainty/variability simulation are on by
default:
```{r css_examples2, eval = TRUE}
set.seed(654321)
calc_mc_css(chem.cas = "80-05-7", daily.dose = 1, which.quantile = 0.5,
            output.units = "uM", 
            samples = 1000)
```
Simple "reverse dosimetry" *in vitro-in vivo* extrapolation (IVIVE) determines
an oral equivalent dose by taking an *in vitro* concentration $$C_{in vitro}$$
(50 uM in the example below) and dividing it by the steady-state plasma 
concentration $$C_{ss}$$ produced by a dose rate of 1 mg/kg bw/day:

$$ OED = C_{in vitro} / C_{ss}$$

We can also calculate the OED using literature values or new httk sampling:
```{r literature_oral_equivalent_example, eval = TRUE}
get_wetmore_oral_equiv(50, chem.cas = "80-05-7")
set.seed(654321)
calc_mc_oral_equiv(50, chem.cas = "80-05-7")
```

## Monte Carlo Simulation of Css
To perform a Monte Carlo simulation on Zoxamide with the
model pbtk with the same limit of detection and coefficients of
variation (cv) of two thirds the size of those used in calc mc css, we
have.
Note, the function "monte_carlo" was renamed "calc_mc_tk", while a new
"monte_carlo" was created to complement "httkpop_mc" and "invitro_mc".
```{r monte_carlo_css_example, eval = TRUE}
vary.params <- NULL
params <- parameterize_pbtk(chem.name = "Zoxamide")
for (this.param in names(subset(params, names(params) != "Funbound.plasma")))
  # Only want to vary numerical parameters:
  if (is.numeric(params[[this.param]])) 
      vary.params[this.param] <- 0.2
censored.params <- list(Funbound.plasma = list(cv = 0.2, lod = 0.01))
set.seed(1)
# Solve the full time-course:
out <- calc_mc_tk(parameters=params, 
                  vary.params = vary.params,
                  censored.params = censored.params,
                  return.samples = TRUE, 
                  model = "pbtk",
                  suppress.messages = TRUE,
                  httkpop = FALSE,
                  invitrouv = FALSE,
                  samples = 50)
# Make a table with confidence intervals:
zoxtable <- cbind(out[["means"]][,"time"],
                  out[["means"]][,"Cplasma"],
                  out[["means"]][,"Cplasma"] - 1.96*out[["sds"]][,"Cplasma"],
                  out[["means"]][,"Cplasma"] + 1.96*out[["sds"]][,"Cplasma"])
colnames(zoxtable) <- c("time","Cplasma","lcl","ucl")
zoxamide1 <- ggplot(as.data.frame(zoxtable), aes(x=time,y=Cplasma)) +
    geom_line(color = "dark blue",size=2) +
      geom_ribbon(aes(ymin=lcl, ymax=ucl), alpha = 0.3,
                  fill = "light blue", color="black", linetype="dotted")+
    ylab("Plasma concentration") +
    xlab("Time (days)") +
    theme(axis.text = element_text(size = 16),
          axis.title = element_text(size = 16))
print(zoxamide1)

# Just Css time-course:
out <- calc_mc_css(parameters=params, 
                  vary.params = vary.params,
                  censored.params = censored.params,
                  return.samples = TRUE, 
                  model = "pbtk",
                  suppress.messages = TRUE,
                  httkpop = FALSE,
                  invitrouv = FALSE,
                  samples = 50)

zoxamide2 <- ggplot(as.data.frame(out), aes(out)) +
    geom_histogram(fill = "blue", binwidth = 1/6) +
    scale_x_log10() + ylab("Number of Samples") +
    xlab("Steady State Concentration (uM)") +
    theme(axis.text = element_text(size = 16),
          axis.title = element_text(size = 16))
print(zoxamide2)
```
```{r remaining_code, eval = FALSE}

## We can add thyroid to the tissue data by making a row containing
## its data, subtracting the volumes and flows from the rest, and
## binding the row to tissue.data.

new.tissue <- subset(tissue.data,Tissue == "spleen")
new.tissue[, "Tissue"] <- "thyroid"
new.tissue[new.tissue$variable %in% c('Vol (L/kg)','Flow (mL/min/kg^(3/4))'),'value'] <- 
   new.tissue[new.tissue$variable %in% c('Vol (L/kg)','Flow (mL/min/kg^(3/4))'),'value']/10
tissue.data[tissue.data$Tissue == "rest", 'value'] <-
    tissue.data[tissue.data$Tissue == "rest", 'value'] - new.tissue[new.tissue$variable %in% c('Vol (L/kg)','Flow (mL/min/kg^(3/4))'),'value']
tissue.data <- rbind(tissue.data, new.tissue)

## To generate the parameters for a model with kidneys, thyroid, a
## liver compartment combining the liver and gut, and a rest of body
## compartment:
compartments <- list(liver = c("liver", "gut"), kidney = "kidney",
                     thyroid = "thyroid")
parameterize_pbtk(chem.name = "Nicotine", tissuelist = compartments)

## Below is a call of an export function for a dose of 1 given to a
## rat.
export_pbtk_sbml(chem.name = "Bisphenol A", species = "Rat",
                 initial.amounts = list(Agutlumen = 1),
                 filename = "PBTKmodel.xml")
                                        
## Figures 3 and 4
library("httk")
library("ggplot2")
days <- NULL
avg <- NULL
max <- NULL
for (this.cas in get_cheminfo(model='pbtk')) {
    css.info <- calc_css(chem.cas = this.cas,
                         doses.per.day = 1,
                         suppress.messages = TRUE)
    days[[this.cas]] <- css.info[["the.day"]]
    avg[[this.cas]] <- css.info[["avg"]]
    max[[this.cas]] <- css.info[["max"]]
}
days.data <- as.data.frame(days)
hist <- ggplot(days.data, aes(days)) +
    geom_histogram(fill = "blue", binwidth = 1/4) +
    scale_x_log10() + ylab("Number of Chemicals") + xlab("Days") +
    theme(axis.text = element_text(size = 16),
          axis.title = element_text(size = 16))
hist

avg.max.data <- data.frame(avg, max)
avg.vs.max <- ggplot(avg.max.data, aes(avg, max)) +
    geom_point() + geom_abline() +
    scale_x_log10() + scale_y_log10() +
    xlab("Average Concentration at Steady State (uM)") +
    ylab("Max Concentration at Steady State (uM)") +
    theme(axis.text = element_text(size = 16),
          axis.title = element_text(size = 16))
avg.vs.max
```
