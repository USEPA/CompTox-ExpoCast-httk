---
title: "Introduction to *In Vitro-In Vivo* Extrapolation (IVIVE) with R Package httk"
author: "John Wambaugh"
date: "November, 2022"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Introduction to IVIVE}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---
*Please send questions to wambaugh.john@epa.gov*

Chemical risk assessment depends on knowledge of inherent chemical hazard,
the dose-response relationship, and the extent of exposure that occurs ([NASEM 2017](<https://doi.org/10.17226/24635>)).
High throughput screening (HTS) for *in vitro* bioactivity allows 
characterization of potential hazard for thousands of chemicals for which no other testing has occurred
([Judson et al., 2009](<https://doi.org/10.1289/ehp.0800168>)).

Toxicokinetics (TK) describes the Absorption, Distribution, Metabolism, and Excretion (ADME) of a chemical by the body. TK relates external exposures to internal tissue concentrations of chemical and
therefore informs the chemical dose-response relationship ([Coecke et al., 2013](<https://doi.org/10.1016/j.tiv.2012.06.012>)). TK requires chemical-specific information that is traditionally obtained *in vivo*.
However, most chemicals do not have TK data, so a new approach methodology (NAM) uses *in vitro* TK methods adapted from the pharmaceutical industry to provide the necessary chemical-specific information
([Wambaugh et al., 2019](https://doi.org/10.1016/j.cotox.2019.07.001), [Chang et al., 2022](<https://doi.org/10.3390/toxics10050232>)).
High(er) throughput toxicokinetics (HTTK) involves the combination of chemical-specific *in vitro* TK data  and chemical-independent ("generic") TK models to predict TK ([Breen et al., 2021](<https://doi.org/10.1080/17425255.2021.1935867>)).

The primary goal of HTTK is to provide a human dose context for bioactive *in vitro* concentrations from HTS (that is, *in vitro-in vivo* extrapolation, or IVIVE) ([Wetmore, 2015](<https://doi.org/10.1016/j.tox.2014.05.012>)).
IVIVE is Utilization of *in vitro* experimental data to predict phenomena in vivo.
In pharmaceutical development, HTTK methods allow IVIVE to estimate therapeutic doses for clinical studies – predicted concentrations are typically on the order of values measured in clinical trials ([Wang, 2010](<https://doi.org/10.1124/dmd.110.032177>)).
High throughput screening + IVIVE can predict a daily chemical dose rate (mg/kg bw/day) that might be adverse ([Paul Friedman et al., 2019](<https://doi.org/10.1093/toxsci/kfz201>)).

A secondary goal is to provide open source data and models for evaluation and use by the scientific community ([Pearce et al., 2017](<https://doi.org/10.18637%2Fjss.v079.i04>)).

The following material is from a lecture taught as part of the course
"Computational Methods in Chemical Risk Assessment"
at Rutgers University in September, 2019.

## HTTK Version

This vignette was created using **httk** v2.2.2 in 2022. Although we attempt to maintain 
backward compatibility, if you encounter issues with the latest release of **httk**
and cannot easily address the changes, historical versions of **httk** are 
available from: https://cran.r-project.org/src/contrib/Archive/httk/


# Getting Started

For an introduction to R, see Irizarry (2022) "Introduction to Data Science": 
<https://rafalab.github.io/dsbook/getting-started.html>

For an introduction to toxicokinetics, with examples in **httk**, see Ring (2021) in the "TAME Toolkit":
<https://uncsrp.github.io/Data-Analysis-Training-Modules/toxicokinetic-modeling.html>

## Files and Folders

R (or any computer program) needs to know where to look to find particular information (such as data generated by a panel of in vitro assays). 
We describe a chunk of information as a "file". Files range in size and can be small (even 0 bytes) or very large (several GB).
A file my physically be located on a disk drive inside your computing device or, increasingly, it might be located somewhere in a cloud storage network.
Regardless, most computers will treat a file as if it has a specific location.
Each file has a name, although multiple files can have the same name as long as those files are stored in different "folders".

Files for all the operating systems with R are organized using a folder (also called a "directory") and sub-folder structure. 
A sub-folder is a folder within another folder. They can be well organized:

/animals/cats/tabbies/

Or not:

/animals/gradschoolfiles/photosfromchildhood

The sequence of folders and sub-folders leading to a particular file is referred to as a "path". 
For information on how folder structures work, please check out these sites:

* <https://en.wikipedia.org/wiki/Directory_structure>
* <https://www.geeksforgeeks.org/structures-of-directory-in-operating-system/>
* <https://www.westga.edu/its/assets-its/docs/understanding_directory_structure_windows.pdf>

Within the command shell you use the "cd" command to "change directories".

One complication to watch out for is the direction of the symbol that separates folder names in the path.
On Windows the path is separated by "back-slashes": \\

\\animals\\cats\\black

On Unix-based operating systems (including Linux and MacOS) the path is separated by "forward slashes": /

/animals/cats/black

R always uses Unix forward slashes, even on a Windows machine, so if you know that the path is:

c:\\users\\USERNAME\\Downloads\\

You need to tell R that you want:

c:/users/USERNAME/Downloads/

Finally, the bit at the front of the path (such as "C:\\" or "L:\\" tells the computer which "drive" to look in to find your folders.
Often "C drive" (c:\\) is physically inside your machine while other letters might indicate network (or cloud) drives.

### Home Directory
Whether you are on Linux or Windows you have a home directory. 
Often you will only be able to write and edit files within your home directory and its sub-directories. However, you may be able to read and copy from most other folders.

On Windows your home directory will be a sub-directory of "C:\\users\\". For example, "C:\\users\\jwambaug".

### Common and Important Directories
You will want to create a directory for your R packages locally on your machine:

C:\\users\\USERNAME\\AppData\\Loca\\R

### Download Folders
Many web browsers put their files in a default directory such as

C:\\users\\USERNAME\\Downloads

### Temporary (or "Swap") Space
On Windows the path "c:\\" refers to the physical hard drive inside your computer. Therefore the only copy of "c:\\users\\USERNAME\\" is on your computer and if that drive or the whole computer is damaged or destroyed you have lost those files. For this reason we call this "temporary" space. You don't want to keep the only copies of your files there.

## Installing Necessary Software

* Users will need the freely available R statistical computing language: <https://www.r-project.org/>
* Users will likely want a development environment like RStudio: <https://www.rstudio.com/products/rstudio/download/>
* If you get the message "Error in library(X) : there is no package called 'X'" then you will need to install that package: 
	From the R command prompt: install.packages("X") 
  Or, if using RStudio, look for 'Install Packages' under the 'Tools' tab.
* Note that R does not recognize fancy versions of quotation marks ‘,$~$’,$~$“, or$~$”. 
If you are cutting and pasting from software like Word or Outlook you may need 
to replace the quotation marks that curve toward each other with ones typed by 
the keyboard.

### Installing R package "httk"
```{r install_httk, eval = FALSE}
install.packages("httk")
```

### Installing R package "readxl"
```{r install_readxl, eval = FALSE}
install.packages("readxl")
```

## Set vignette options
```{r setup_vignette, eval = TRUE}
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=4)
```

## Delete all objects from memory:
```{r clear_memory, eval = TRUE}
rm(list=ls())
```

## Load the necessary packages:
```{r load_packages, eval = TRUE}
library(httk)
library(readxl)
```

# *In Vitro* Screening Data

**ToxCast pargraph from paper**

Load ToxCast Data for Specific Chemicals from the CompTox Dashboard:

Download the ToxCast data: 
<https://www.epa.gov/chemical-research/exploring-toxcast-data-downloadable-data>

* Go to “Download ToxCast Summary Information”
* Download INVITRODB_V3_2_SUMMARY.zip and place it in your R working folder
* Unzip the file ac50_Matrix_190708.csv so that it is in your R working folder

Don't forget to use "setwd(FOLDERPATH)" to change to your R working folde

Load the matrix of ToxCast fifty percent activation concentrations (AC50's) 
given in uM by assay. "NA" indicates that the assay was not run for that
chemical.

```{r load_hts, eval = FALSE}
toxcast <- read.csv("ac50_Matrix_190708.csv",stringsAsFactors=F)
```

Download a list of chemicals from the CompTox Chemicals Dashbaord and save as "mychems.xls"
<http://comptox.epa.gov/dashboard/>
```{r load_mychems, eval = FALSE}
mychems <- read.xls("mychems.xls",stringsAsFactors=F)
```

## Take a look at the first few rows of your table:
head(mychems)

## Get the ToxCast data for only the chemicals of interest:
my.tox <- subset(toxcast,CAS%in%mychems$CASRN)

## How many chemicals covered by ToxCast (dim gives number of rows and columns):
dim(my.tox)
## Out of how many chemicals of interest:
dim(mychems)  
  
## Mark the columns with ToxCast AC50s:
toxcast.start <- 2
toxcast.end <- 1474

## Find the tenth percentile AC50 for each chemical:
my.tox$tenth <- apply(my.tox[,toxcast.start:toxcast.end],
                  1,
                  function(x) quantile(x,0.1,na.rm=T))

## Get rid of chemicals where there is no hit (1,000,000 or 1e6 denotes no hit):
my.tox <- subset(my.tox,tenth<1e6)
## Reduce to just the tneth percentile concentration (uM):
my.tox <- my.tox[,c("CAS","tenth")]
## Add the other chemical information:
my.tox <- merge(my.tox,mychems,by.x="CAS",by.y="CASRN")


# STEP TWO
# Perform steady-state reverse dosimetry in vitro-in vivo extrapolation (IVIVE):

library(httk)
# For each chemical in your subset of ToxCast, add the HTTK plasma steady-state 
# concentration if it is available:
for (this.cas in my.tox$CAS)
{
# get_cheminfo() gives a list of all the CAS numbers for which HTTK will work:
  if (this.cas %in% get_cheminfo())
  {
# Set a random number generator seed so that the Monte Carlo will always give
# the same random sequence:
    set.seed(12345)
# calc_mc_css gives us the predicted plasma concentration for a 1 mg/kg/day 
# dose at steady-state:
    my.tox[my.tox$CAS==this.cas,"Css"] <- 
      calc_mc_css(chem.cas=this.cas,output.units="uM")
    my.tox[my.tox$CAS==this.cas,"Css.Type"] <- "in vitro"
  }
}
# Let's look at just the relevant columns from our table. Any NA's indicate that
# we don't currently have in vitro TK data for those chemicals:
my.tox[,c("PREFERRED_NAME","tenth","Css","Css.Type")]


# STEP THREE
# Load the table of quantitative structure-property relationship (QSPR) model
# predictions from the Sipes et al. (2017) supplemental material:
load_sipes2017()
# Now go through the list of chemicals again:
for (this.cas in my.tox$CAS)
{
# But only calculate if we didn't already have a value (NOTE: load_sipes2017
# will not overwrite the in vitro data by default, so you'll still get the same
# answer if you use the same random number seed, but you would also be wasting
# time):
  if (this.cas %in% get_cheminfo() &
    is.na(my.tox[my.tox$CAS==this.cas,"Css"]))
  {
    set.seed(12345)
# This gives us the predicted plasma concentration for a 1 mg/kg/day dose at 
# steady-state:
    my.tox[my.tox$CAS==this.cas,"Css"] <- 
      calc_mc_css(chem.cas=this.cas,output.units="uM")
    my.tox[my.tox$CAS==this.cas,"Css.Type"] <- "in silico"
  }
}
# Take another look at our table many of the gaps are filled in:
my.tox[,c("PREFERRED_NAME","tenth","Css","Css.Type")]

par(mar = c(3, 2, 2,2))
plot(x=1:14,
     y=my.tox$BER,
     log="y",
     xaxt="n", 
     xlab="")
axis(1, at=1:14,
     labels=substr(my.tox$PREFERRED_NAME,1,10),las=2)



# STEP FOUR
# Calculate the equivalent steady-state dose to produce plasma cocnentration 
# equal to tenth percentile Toxcast AC50
my.tox$EquivDose <- my.tox$tenth / my.tox$Css
# Look at the table again:
my.tox[,c("PREFERRED_NAME","tenth","EquivDose")]          
    
                  
# STEP FIVE
# Find the appropriate SEEM3 consensus exposure predictions to prioritize these
# chemicals on the basis of putative risk

# Load the supplemental information from Ring et al. (2018):
SEEM3 <- read.csv("SupTable-all.chem.preds-2018-11-28.txt",stringsAsFactors=F)

# Merge the consensus model predictions with your table:
my.tox <- merge(my.tox,SEEM3[,c("CAS","seem3","seem3.l95","seem3.u95","Pathway","AD")])

# Calulate a bioactivity:exposure ratio:
my.tox$BER <- my.tox$EquivDose/my.tox$seem3.u95
 
# Reorder your table by BER:
my.tox <- my.tox[order(my.tox$BER),]

# Make a plot:
# Change the plot margins:
par(mar = c(7, 5, 4,2))
# Convert the chemical names into factors for plotting:
plot(x=factor(my.tox$PREFERRED_NAME,levels=my.tox$PREFERRED_NAME),
     y=my.tox$BER,
# Use a log scale on the y-axis:
     log="y",
     xaxt="n", 
     xlab="",
     ylab="Bioactivity:Exposure Ratio",
     cex.lab=1.5)
# Plot the first 15 characters of each chemical name on the horizontal eaxis:
axis(1, at=factor(my.tox$PREFERRED_NAME,levels=my.tox$PREFERRED_NAME),
     labels=substr(my.tox$PREFERRED_NAME,1,15),las=2)




