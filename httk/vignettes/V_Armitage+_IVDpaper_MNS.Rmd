---
title: "Modeling in vitro distribution improves accuracy of bioavailable dose estimation"
author: "Meredith N. Scherer, Katie Paul-Friedman, and John F. Wambaugh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{h) Kapraun (2022): Human Gestational Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
*Please send questions to wambaugh.john@epa.gov*

from "Empirical Evaluation of In Vitro Disposition Models"

Meredith N. Scherer, Katie Paul-Friedman, John F.Wambaugh

### update w/paper info + link to cleared dataset

## Abstract

Cell-based in vitro chemical toxicology observes cellular perturbations caused by increasing the concentration of test chemical. The aim of toxicological in vitro to in vivo extrapolation is to predict whole animal effects from perturbations observed in vitro. Reliance on nominal (tested) concentration does not account for chemical binding between the test compound and other, non-cellular, elements of the in vitro assay system. This chemical distribution reduces the free concentration available to cause cellular effects and can result in an inaccurate estimate of the dose causing any observed perturbations. There are mathematical, chemical property-based partitioning models for predicting cellular concentration when not measured experimentally. We evaluated two of these in vitro disposition models: Armitage et al., 2014 and Kramer et al., 2010 using 174 experimental intracellular concentration measurements of 54 chemicals, along with parameters describing measurement conditions, all from the scientific literature. Among the chemicals examined, the Armitage model’s predictions (root mean squared log10 error (RMSLE) = 1.28) and the Kramer model (RMSLE = 1.59) were more accurate than using the nominal concentration (RMSLE = 1.72). Although limited by the amount of available measurement data, these results indicate that mathematical modeling of in vitro distribution may improve the accuracy of IVIVE.

## HTTK Version 

This vignette was created with **httk** v2.X.0. Although we attempt to maintain 
backward compatibility, if you encounter issues with the latest release of 
**httk**
and cannot easily address the changes, historical versions of httk are 
available from: https://cran.r-project.org/src/contrib/Archive/httk/

## Prepare for session
R package **knitr** generates html and PDF documents from this RMarkdown file,
Each bit of code that follows is known as a "chunk". We start by telling 
**knitr** how we want our chunks to look.
```{r configure_knitr, eval = TRUE}
knitr::opts_chunk$set(collapse = TRUE, comment = '#>')
options(rmarkdown.html_vignette.check_title = FALSE)
```

### Clear the memory
It is a bad idea to let variables and other information from previous R
sessions float around, so we first remove everything in the R memory.
```{r clear_memory, eval = TRUE}
rm(list=ls()) 
```

### eval = execute.vignette
If you are using the RMarkdown version of this vignette (extension, .RMD) you
will be able to see that several chunks of code in this vignette
have the statement "eval = execute.vignette". The next chunk of code, by default,
sets execute.vignette = FALSE.  This means that the code is included (and necessary) but was
not run when the vignette was built. We do this because some steps require 
extensive computing time and the checks on CRAN limit how long we can spend
building the package. If you want this vignette to work, you must run all code,
either by cutting and pasting it into R. Or, if viewing the .RMD file, you can
either change execute.vignette to TRUE or press "play" (the green arrow) on
each chunk in RStudio.
```{r runchunks, eval = TRUE}
# Set whether or not the following chunks will be executed (run):
execute.vignette <- TRUE
```

### Load the relevant libraries
We use the command 'library()' to load various R packages for our analysis.
If you get the message "Error in library(X) : there is no package called 'X'"
then you will need to install that package: 

From the R command prompt:

install.packages("X")

Or, if using RStudio, look for 'Install Packages' under 'Tools' tab.

```{r load_packages, eval = execute.vignette}
#
#
# Setup
#
#
#library(httk)        # run Armitage.R in vitro distribution model
library(tidyverse)   # data wrangling
library(data.table)  # data table functionality
library(ggplot2)     # plotting
library(ggpubr)      # arrange plots for publication

##delete once httk has been updated with armitage.R file and model_param_armitage.R and un-tab out library(httk) above
library(devtools) # to run httk
suppressWarnings(setwd("C:/Users/mscherer/httk-dev")) # to load httk
suppressWarnings(devtools::load_all("httk")) # for armitage

#save figures and tables to working directory: yes/no
save_output = FALSE

#for saving outputs
data.date <- "10JUN2025"
path_out <- "C:/Users/mscherer/OneDrive - Environmental Protection Agency (EPA)/Profile/Desktop/ManuscriptDataJourney/manuscript figures 18JUN/"


```

```{r rmsle_func}
#function to calculate RMSLE
sle <- function (actual, predicted) 
{
    log.act <- log10(actual)
    log.pred <- log10(predicted)
    good <- !is.na(log.act) & is.finite(log.act) &
            !is.na(log.pred) & is.finite(log.pred)
    log.act <- log.act[good]
    log.pred <- log.pred[good]
    return((log.act - log.pred)^2)
}
msle <- function (actual, predicted) 
{
    mean(sle(actual, predicted))
}
rmsle <-function (actual, predicted) 
{
    sqrt(msle(actual, predicted))
}
```

# Data Collection

Data sets were curated from the literature to evaluate the in vitro distribution model. 


# Load and format the data

```{r load_IVD_Manuscript_data, eval = execute.vignette}

#you know it is correct if IVD_Manuscript_data has 174 obs of 29 variables
#IVD_Manuscript_data <- httk::IVD_Manuscript_data
#load("C:/Users/mscherer/httk-dev/httk/data/ArmitagePlus_Vignette_2JUN25.RData")
load("C:/Users/mscherer/httk-dev/httk/data/ArmitagePlus_Vignette_10JUN25.RData")


cat(paste("Summarized data from ", 
          length(unique(IVD_Manuscript_data$Citation)),
          " studies covering ", 
          length(unique(IVD_Manuscript_data$ChemicalName)),
          " unique chemicals ", 
          "with ",
          length(IVD_Manuscript_data$CellConcentration_uM),
          " observations total.",
          sep="")
    )

#14 studies, 43 chemicals, 163 observations

#number each row
IVD_Manuscript_data[,X:=1:length(IVD_Manuscript_data$ChemicalName)]

```

#In vitro assay descriptors (optional step)
In vitro assay descriptors for the measurements in Supplemental Materials Table S2 were added as additional assays into httk:invitro.assay.params using the AENM “IVD” + Author + Year (that is, Smith et al. (2000) would be AENM “IVDSmith2000”. 
```{r}

### Create assay_component_endpoint_name columns for experimental assay parameters ###

#create assay_name column
IVD_Manuscript_data[, assay_name := gsub(", ", "", IVD_Manuscript_data$Citation)]

#create the assay_component_endpoint_name column
IVD_Manuscript_data[, assay_component_endpoint_name := paste("IVD", gsub(", ", "", assay_name), sep="")]
IVD_Manuscript_data$assay_component_endpoint_name
#tack on the "interesting" part for each assay to create the assay_component_endpoint_name 
  #(these ones have multiple concentrations or time points)
IVD_Manuscript_data[assay_component_endpoint_name=="IVDBellwon2015b" |
                  assay_component_endpoint_name == "IVDBroeders2013" |
                  assay_component_endpoint_name == "IVDWei2010",
                assay_component_endpoint_name := paste(assay_component_endpoint_name, CellType, sep="_")]

#same here
IVD_Manuscript_data[assay_component_endpoint_name=="IVDMundy2004" |
                      assay_component_endpoint_name=="IVDLundquist2014",
                assay_component_endpoint_name := paste(paste(assay_component_endpoint_name, paste(ExposureDuration_hrs, "hr", sep = ""), sep="_"), paste(FBSf, "FBSf", sep = ""), sep = "_")]

#pull a copy with the assay parameters so we have it for the options table
options.IVD_Manuscript_data<-copy(IVD_Manuscript_data)

### pull in assay table ###

#load in vitro assay parameters table
#load("C:/Users/mscherer/httk-dev/httk/data/invitro.assay.params.RData")
invitro.assay.params <- copy(invitro.assay.params)

#copy the experimental data frame to pull out the parameter lines
parameters_only<-copy(IVD_Manuscript_data)

### Set up experimental assay parameters to match with invitro.assay.params.RData ###

#rename columns to align with the names in invitro.assay.params.RData
parameters_only[, timepoint_hr := ExposureDuration_hrs] %>%
  .[, media_serum := SerumType] %>%
  .[, cell_type := CellType] 

# get the list of columns we need
ivpnames<-names(invitro.assay.params)

#add on the extra columns to match invitro.assay.params and parameters_only
if(!all(ivpnames%in%names(parameters_only))){
    parameters_only[,ivpnames[!(ivpnames %in% names(parameters_only))]] <- as.double(NA)}

#filter parameters_only to match up with ivpnames and only the unique rows
parameters_only<-parameters_only %>% select(as.character(ivpnames)) %>% unique()

# reassign own parameters table to pass to armitage function
user_assay_parameters<-parameters_only
# should have 29 + 1649 = 1678 rows

#check all experimental assay endpoint names are present in the parameters table 
#unique(IVD_Manuscript_data[,(assay_component_endpoint_name)]) %in% user_assay_parameters[,(assay_component_endpoint_name)]
# all true = ready to run!

#delete the surface area and other assay info from IVD_Manuscript_data to check whether sarea is running correctly
#overlapping columns in IVD_Manuscript_data and ivpnames should be replaced with null (columns removed)
ivpnames[2]<-NA #remove assay_component_endpoint_name bc we need to be able to reference it
IVD_Manuscript_data[,ivpnames[(ivpnames %in% names(IVD_Manuscript_data))]]<- NULL

#checkpoint<-copy(IVD_Manuscript_data)
#
#names(parameters_only)

```


# Run the in vitro distribution models
```{r run_IVD_models, eval = execute.vignette}


# # run Armitage model, output concentrations in umol/L (e.g. uM)
armitageOutput_data.dt <- armitage_eval(tcdata=IVD_Manuscript_data,
                                       surface.area.switch = TRUE,
                                       user_assay_parameters = user_assay_parameters,
                                       restrict.ion.partitioning = TRUE)



# run Kramer model, output concentrations in umol/L (e.g. uM)
kramerOutput_data.dt <- kramer_eval(tcdata=IVD_Manuscript_data, 
                                    surface.area.switch = TRUE,
                                    user_assay_parameters = user_assay_parameters,
                                    restrict.ion.partitioning = TRUE)
```

# Manipulate data for plotting
```{r manipulate_for_plotting, eval = execute.vignette}

#subset then combine into one big dataset
Armitage.dt<-subset(armitageOutput_data.dt, select=-c(nomconc))
Kramer.dt_subset<-subset(kramerOutput_data.dt, select=-c(nomconc))
Kramer.dt<-cbind(Kramer.dt_subset, IOC_Type = Armitage.dt$IOC_Type)
Nominal.dt_subset<-subset(kramerOutput_data.dt, select = -c(concentration_cells))
Nominal.dt<-cbind(Nominal.dt_subset, IOC_Type = Armitage.dt$IOC_Type)

Armitage.dt[,label:= "Armitage"]
Kramer.dt[,label:= "Kramer"]
Nominal.dt[,label:= "Nominal"]

#combine data in plotting form
combodata<-merge(Armitage.dt, kramerOutput_data.dt, by = "X", all.x = TRUE) #kramer output still has nomconc values 

if(save_output){
  write.csv(combodata, file = paste0(path_out,"ManuscriptOutput_",data.date,"_",Sys.Date(),".csv"))
}

# combodata %>% dplyr::filter(Citation.x== "Tox21" | Citation.x == "Steve Ferguson") %>% select(ChemicalName.x) %>% distinct
# 
# #70 datapoints from them, 13 chemicals
# 
# combodata %>% dplyr::filter(Citation.x != "Tox21" & Citation.x != "Steve Ferguson") %>% select(ChemicalName.x, Citation.x) %>% distinct(Citation.x)
# #93 data points, 32 chemicals

```


# Main Paper Plots:

## Figure 1: In Vitro Distribution Diagram (no code)

## Figure 2: Predicted and experimental intracellular concentrations from the Nominal = Cfree (left panel), Armitage (middle panel), and Kramer (right panel) models. Dashed line shows unity.
  
```{r joint_intracel_plot_2, eval = execute.vignette}

#ARMITAGE:

#Armitage RMSLE:
arm_rmsle_long<-rmsle((Armitage.dt$CellConcentration_uM),(Armitage.dt$ccells))
arm_rmsle<-round(arm_rmsle_long, 2)
#1.29

#Armitage r^2:
ml_arm_overall = lm(CellConcentration_uM~ccells, data = Armitage.dt)
summary(ml_arm_overall)$r.squared 

# now plot
Armitage_ccell<-ggplot(Armitage.dt, aes(ccells, CellConcentration_uM, 
                        colour = ChemicalName)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed") +
                        xlab("Armitage Predicted Intracellular Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        scale_y_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        annotate("text", x = Inf, y = Inf, label = paste("RMSLE: ", arm_rmsle), 
                                 vjust = 28, hjust = 1, size = 3) +
                        theme_bw() + 
                        theme(legend.position = "none",
                              text=element_text(size=8),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"))


#KRAMER:

#Kramer RMSLE:
kram_rmsle_long<-rmsle((Kramer.dt$CellConcentration_uM),(Kramer.dt$concentration_cells))
kram_rmsle<-round(kram_rmsle_long, 2)
#1.64

#Kramer r^2:
ml_kram_overall = lm(CellConcentration_uM~concentration_cells, data = Kramer.dt)
summary(ml_kram_overall)$r.squared 

# now plot
Kramer_ccell<-ggplot(Kramer.dt, aes(concentration_cells, CellConcentration_uM, 
                        colour = ChemicalName)) +
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed") +
                        scale_y_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        xlab("Kramer Predicted Intracellular Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        annotate("text", x = Inf, y = Inf, label = paste("RMSLE: ", kram_rmsle), 
                                 vjust = 28, hjust = 1, size = 3) +
                        theme_bw() + 
                        theme(legend.position = "none",
                          text=element_text(size=8),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black")) 


#NOMINAL:

#Nominal RMSLE:
nom_rmsle_long<-rmsle((Nominal.dt$CellConcentration_uM),(Nominal.dt$nomconc))
nom_rmsle<-round(nom_rmsle_long, 2)
#1.69

# now plot
Nominal_ccell<-ggplot(Nominal.dt, aes(nomconc, CellConcentration_uM, 
                        colour = ChemicalName)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed") +
                        scale_y_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.00001, 400000), trans='log10') +
                        xlab("Nominal Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        labs(color = "Chemical")+
                        annotate("text", x = Inf, y = Inf, label = paste("RMSLE: ", nom_rmsle), 
                                 vjust = 28, hjust = 1, size = 3) +
                        theme_bw() + 
                        theme(legend.position = "bottom",
                          legend.key.size = unit(2, 'mm'),
                          text=element_text(size=8),
                          legend.spacing = unit(10, "pt"),
                          legend.text = element_text(size = 6),
                          panel.border = element_blank(), 
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(), 
                          axis.line = element_line(colour = "black"))+
                        guides(col = guide_legend(ncol = 7))

#Combine the three plots w RMSLE
Ccells_comboplot<-ggarrange(Nominal_ccell, Armitage_ccell, Kramer_ccell, ncol=3 , legend = "bottom", common.legend = TRUE)

#save
if(save_output){
  ggsave(file = paste0("Figure2_",data.date,"_",Sys.Date(),".png"),
         path = path_out,
         Ccells_comboplot, width = 10, height = 5, dpi = 300)
}


print(Ccells_comboplot)

```



## Figure 3: Predicted and experimental intracellular concentrations from the Armitage (left panel) and Kramer (right panel) models for the twenty chemicals with multiple observations. Solid lines connect multiple measurements for a single chemical. The dashed line shows unity. 
  
```{r multiobs_intracel_plot, eval = execute.vignette}

#how many chemicals only have more than one observation?
#multiObsChemnameList<-Armitage.dt %>% group_by(ChemicalName) %>% summarize(n=n()) %>% dplyr::filter(n>=2)  %>% distinct()
#20 chemicals have multiple observations 
#but we want multiple observations AND multiple nomconcs reported

#Armitage.multobs.dt %>% count(ChemicalName, NominalDose_uM, Citation)
#some of these have super close nomconcs because they are experimentally measured - not really relevant for this comparison because they are replicates
#chemicals to remove:
#Hexachlorobenzene, Malathion, Pentachlorophenol, Propiconazole (all of the chemicals from Stadnicka, 2014 which makes sense)

multiObsChemnameList<-Armitage.dt %>% dplyr::filter(Citation != "Stadnicka, 2014") %>% 
  count(ChemicalName, NominalDose_uM) %>% 
  count(ChemicalName) %>% dplyr::filter(n>=2) %>% select(ChemicalName) %>% distinct()
#10 chemicals with multiple nominal doses measured

Armitage.multobs.dt_og <- Armitage.dt %>% 
  dplyr::filter(ChemicalName %in% multiObsChemnameList$ChemicalName)

Kramer.multobs.dt_og <- Kramer.dt %>% 
  dplyr::filter(ChemicalName %in% multiObsChemnameList$ChemicalName)

Nominal.multobs.dt_og <- Nominal.dt %>% 
  dplyr::filter(ChemicalName %in% multiObsChemnameList$ChemicalName)

#each have 89 observations

#need to merge the lines with multiple observations for the same nomconc (ie tox21) because they are pulled in from the crossover 
#with the above call  
#isolate the lines that fall into this category

#pull out the observations for these chemicals
Armitage.multobs.dt<-Armitage.multobs.dt_og %>% group_by(ChemicalName, NominalDose_uM) %>% 
  mutate(mean_measuredccell = mean(CellConcentration_uM),
         mean_predictedccell = mean(ccells)) %>% 
  select(ChemicalName, NominalDose_uM, mean_measuredccell, mean_predictedccell) %>% distinct()

Kramer.multobs.dt<-Kramer.multobs.dt_og %>% group_by(ChemicalName, NominalDose_uM) %>% 
  mutate(mean_measuredccell = mean(CellConcentration_uM),
         mean_predictedccell = mean(concentration_cells)) %>% 
  select(ChemicalName, NominalDose_uM, mean_measuredccell, mean_predictedccell) %>% distinct()

Nominal.multobs.dt<-Nominal.multobs.dt_og %>% group_by(ChemicalName, NominalDose_uM) %>% 
  mutate(mean_measuredccell = mean(CellConcentration_uM),
         mean_predictedccell = mean(NominalDose_uM)) %>% 
  select(ChemicalName, NominalDose_uM, mean_measuredccell, mean_predictedccell) %>% distinct()
#down to 50 observations because the duplicates have been averaged


#now plot

#ARMITAGE

#Armitage RMSLE:
arm_mult_rmsle_long<-rmsle((Armitage.multobs.dt$mean_measuredccell),(Armitage.multobs.dt$mean_predictedccell))
arm_mult_rmsle<-round(arm_mult_rmsle_long, 2)
#1.27

#r squared 
ml_arm <- lm(mean_measuredccell~mean_predictedccell, data = Armitage.multobs.dt)
rsq_armitage_mult <- summary(ml_arm)$r.squared
#0.850567

# now plot
Armitage_ccell_mult<-ggplot(Armitage.multobs.dt, aes(mean_predictedccell, mean_measuredccell, 
                        colour = ChemicalName)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed") +
                        geom_smooth(method=lm, se = FALSE) +
                        scale_y_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.0001, 400000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),
                                           limits = c(0.0001, 400000), trans='log10') +
                        xlab("Armitage Predicted Intracellular Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        labs(colour = "Chemical")+
                        annotate("text", x = Inf, y = Inf, label = paste("RMSLE: ", arm_mult_rmsle), 
                                 vjust = 29, hjust = 1, size = 3) +
                        theme_bw() +
                        theme(legend.position = "none",
                              text=element_text(size=8),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"))

#KRAMER

#Kramer RMSLE:
kram_mult_rmsle_long<-rmsle((Kramer.multobs.dt$mean_measuredccell),(Kramer.multobs.dt$mean_predictedccell))
kram_mult_rmsle<-round(kram_mult_rmsle_long, 2)
# 1.60

#r squared 
ml_kram <- lm(mean_measuredccell~mean_predictedccell, data = Kramer.multobs.dt)
rsq_kramer_mult <- summary(ml_kram)$r.squared
#0.8706758

# now plot
Kramer_ccell_mult<-ggplot(Kramer.multobs.dt, aes(mean_predictedccell, mean_measuredccell, 
                        colour = ChemicalName)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed") + 
                        geom_smooth(method=lm, se = FALSE) +
                        scale_y_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.0001, 400000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x), 
                                           limits = c(0.0001, 400000), trans='log10') +
                        xlab("Kramer Predicted Intracellular Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        labs(colour = "Chemical")+
                        annotate("text", x = Inf, y = Inf, label = paste("RMSLE: ", kram_mult_rmsle),
                                 vjust = 29, hjust = 1, size = 3) +
                        theme_bw() + 
                        theme(legend.key.size = unit(2, 'mm'),
                          text=element_text(size=8),
                          legend.spacing = unit(10, "pt"),
                          legend.text = element_text(size = 6),
                          panel.border = element_blank(), 
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(), 
                          axis.line = element_line(colour = "black")) 


#arrange
Ccells_comboplot_mult<-ggarrange(Armitage_ccell_mult, Kramer_ccell_mult, ncol=2, legend = "bottom", common.legend = TRUE)

if(save_output){
  ggsave(file = paste0("Figure3_",data.date,"_",Sys.Date(),".png"),
         path = path_out,
         Ccells_comboplot_mult, width = 8, height = 5, dpi = 300)
}

print(Ccells_comboplot_mult)

# Armitage.multobs.dt %>% 
#   select(ChemicalName, Citation, NominalDose_uM, ccells) %>% 
#   dplyr::filter(ChemicalName=="Triphenyl phosphate" | 
#                   ChemicalName == "N-Phenyl-1,4-benzenediamine" |
#                   ChemicalName == "Thiacloprid" |
#                   ChemicalName == "Rosiglitazone")



```

## Figure 4: Chemical partitioning into water, air, cell, and plastic compartments for the Armitage and Kramer models. Dashed line shows unity.
```{r chemicalPart_intracel_plot, eval = execute.vignette}

#Cwat_uM -------- Cwat_R
Cwater_comparison<-ggplot(combodata, aes(concentration_medium, cwat_s, 
                        colour = ChemicalName.x)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed")+
                        scale_y_continuous(labels = function(x) sprintf("%g", x), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),trans='log10') +
                        ggtitle("Water Concentration") +
                        xlab("Kramer Cmedium (\U00B5M)") + 
                        ylab("Armitage Cwat_s (\U00B5M)")+
                        labs(colour = "Chemical")+
                        theme_bw() + 
                        theme(legend.position = "none",
                              text=element_text(size=12),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"))

#Cair_uM -------- Cair_R
Cair_comparison<-ggplot(combodata, aes(concentration_air, cair, 
                        colour = ChemicalName.x)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed")+
                        scale_y_continuous(labels = function(x) sprintf("%g", x), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),trans='log10') +
                        ggtitle("Air Concentration") +
                        xlab("Kramer Cair (\U00B5M)") + 
                        ylab("Armitage Cair (\U00B5M)")+
                        labs(colour = "Chemical")+
                        theme_bw() + 
                        theme(legend.position = "none",
                              text=element_text(size=12),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"))


#C_cells_uM ----- Ccells
Ccells_comparison<-ggplot(combodata, aes(concentration_cells, ccells, 
                        colour = ChemicalName.x)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed")+
                        scale_y_continuous(labels = function(x) sprintf("%g", x), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),trans='log10') +
                        ggtitle("Cell Concentration") +
                        xlab("Kramer Ccells (\U00B5M)") + 
                        ylab("Armitage Ccells (\U00B5M)")+
                        labs(colour = "Chemical")+
                        theme_bw() + 
                        theme(legend.position = "none",
                              text=element_text(size=12),
                              panel.border = element_blank(), 
                              panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"))

#Aplastic_uM_m2 - (Cplastic_R / Sarea_R)
Aplastic_comparison<-ggplot(combodata, aes(concentration_plastic, cplastic, 
                        colour = ChemicalName.x)) + 
                        geom_point() +
                        geom_abline(intercept=0,slope=1, linetype = "dashed")+
                        scale_y_continuous(labels = function(x) sprintf("%g", x), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),trans='log10') +
                        ggtitle("Plastic Concentration") +
                        xlab("Kramer Cplastic (\U00B5mol/m\U00B2)") + 
                        ylab("Armitage Cplastic (\U00B5mol/m\U00B2)")+
                        labs(colour = "Chemical")+
                        theme_bw() + 
                        theme(legend.key.size = unit(1, 'mm'),
                          text=element_text(size=12),
                          legend.spacing = unit(2, "pt"),
                          legend.text = element_text(size = 6),
                          panel.border = element_blank(), 
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(), 
                          axis.line = element_line(colour = "black")) 


compartment_plots<-ggarrange(Cwater_comparison, Cair_comparison, Ccells_comparison, Aplastic_comparison, common.legend = TRUE, legend = "bottom")


if(save_output){
  ggsave(file = paste0("Figure4_",data.date,"_",Sys.Date(),".png"),
         path = path_out,
         compartment_plots, width = 11, height = 10, dpi= 300)
}


print(compartment_plots)

#count the number of chemicals that kramer and armitage predict to be larger
#combodata %>% group_by(ChemicalName.x) %>% dplyr::filter(concentration_cellsccells) %>% select(ChemicalName.x) %>% distinct()


```

## Figure 5. Comparison of Armitage model using curated vs dashboard physchem values.
```{r}

#working directory
setwd("C:/Users/mscherer/OneDrive - Environmental Protection Agency (EPA)/Profile/Desktop/IVD_Data")

#load data
original_curated.data.df<-read_csv("Dimitrijevic_from_arnot.csv")

#convert to data table for manipulation
original_curated.data.dt <- as.data.table(original_curated.data.df)

#first - run using the default/dashboard values
default.dt<-copy(original_curated.data.dt %>% select(-c( "Arnot_pka", "Arnot_pkb", 
                                                "Chemaxon_pKa", "Chemaxon_pKb", 
                                                "log KOW,N", "log KAW,N", 
                                                "Predicted_Ccell_µM", "FoA")))

# run the model, output concentrations in umol/L (e.g. uM)
armitageOutput_default.dt <- armitage_eval(tcdata=default.dt,
                                        restrict.ion.partitioning = TRUE,
                                        surface.area.switch = FALSE)

#next- run using curated values (EAS-E Suite)
curated.data.dt<-copy(original_curated.data.dt)

#overwrite using curated physchem properties
curated.data.dt[, pKa_Donor := as.character(Arnot_pka)] %>% #acidic
  .[, pKa_Accept := as.character(Arnot_pkb)] %>% #basic
  .[, gkow := `log KOW,N`] %>% # gkow
  .[, gkaw_n := `log KAW,N`] # gkaw

# run the model, output concentrations in umol/L (e.g. uM)
armitageOutput_curated.data.dt <- armitage_eval(tcdata=curated.data.dt,
                                        restrict.ion.partitioning = TRUE,
                                        surface.area.switch = FALSE)

#check that the properties survived through the function
#gkow
armitageOutput_curated.data.dt$gkow_n
armitageOutput_curated.data.dt$`log KOW,N`
armitageOutput_default.dt$gkow
#gkaw
armitageOutput_curated.data.dt$gkaw_n
armitageOutput_curated.data.dt$`log KAW,N`
armitageOutput_default.dt$gkaw_n

armitageOutput_default.dt$ccells
armitageOutput_curated.data.dt$ccells

#save output with these values (Supplemental Materials T9)
defaultvals<- armitageOutput_default.dt %>% select(Name, casrn, gkow_n, gkaw_n, pKa_Donor, pKa_Accept)
curatedvals<-armitageOutput_curated.data.dt %>% select(Name, casrn, gkow_n, gkaw_n, pKa_Donor, pKa_Accept)

#calculate rmsle

#default values

#individual
armitageOutput_default.dt[,rmsle_ccell_default:=rmsle(Reported_Ccell_µM, ccells), by = Name]

#total
RMSLE_default.dt<-rmsle(armitageOutput_default.dt$Reported_Ccell_µM, armitageOutput_default.dt$ccells)
RMSLE_default.dt<-round(RMSLE_default.dt, 3)
#0.582

#curated values

#individual
armitageOutput_curated.data.dt[,rmsle_ccell_curated:=rmsle(Reported_Ccell_µM, ccells), by = Name]

#total
RMSLE_curated.data.dt<-rmsle(armitageOutput_curated.data.dt$Reported_Ccell_µM, armitageOutput_curated.data.dt$ccells)
RMSLE_curated.data.dt<-round(RMSLE_curated.data.dt, 3)
#0.566

#improvement when using curated data:
RMSLE_default.dt-RMSLE_curated.data.dt
#0.016

## difference between the two on a per-chemical basis ##
curated_data.dt<-merge(armitageOutput_default.dt, armitageOutput_curated.data.dt, by = "Name")

#calculate rmsle difference for each chemical
curated_data.dt[,rmsle_difference:=rmsle_ccell_curated-rmsle_ccell_default, by = Name]

library(ggrepel)

curated_difference_httk_plot<-ggplot(curated_data.dt, aes(ccells.y, Reported_Ccell_µM.y, color = Name, label = round(rmsle_difference, 2)))+
  geom_point(size = 4) + 
  geom_abline(intercept=0,slope=1, linetype = "dashed") +
  geom_text_repel() +
                        scale_y_continuous(labels = function(x) sprintf("%g", x),  limits = c(10, 10000), trans='log10') +
                        scale_x_continuous(labels = function(x) sprintf("%g", x),limits = c(10, 10000),  trans='log10') +
                        xlab("Armitage Predicted Intracellular Concentration (\U00B5M)") + 
                        ylab("Experimental Intracellular Concentration (\U00B5M)")+
                        labs(color = "Chemical")+
                        theme_bw() + 
                        theme(legend.position = "bottom",
                          legend.key.size = unit(2, 'mm'),
                          text=element_text(size=10),
                          legend.spacing = unit(10, "pt"),
                          legend.text = element_text(size = 10),
                          panel.border = element_blank(), 
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank(), 
                          axis.line = element_line(colour = "black"))

if(save_output){
  ggsave(file = paste0("Figure5_",data.date,"_",Sys.Date(),".png"),
         path = path_out,
         curated_difference_httk_plot, width = 8, height = 5, dpi = 300)
}


```


# Main paper Calculations:

## Fold Change Between Experimental Intracellular Concentration and Predicted Intracellular Concentration
```{r fold_change_calculation, eval = execute.vignette}

# 1. calculate RMSLE for each value
combodata[, RMSLE_nominal_by_chem := rmsle(CellConcentration_uM.x, nomconc), by = "ChemicalName.x"]

#2. the median difference between nominal and cellular concentration was X-fold
# find the median difference between nominal and cellular concentration
median(combodata$RMSLE_nominal_by_chem) #1.660651

#3. ranging between nominal concentration being X-fold higher than cellular (chemical)
#min(combodata$RMSLE_nominal) #5.46804194 (PBDE-47) - cell conc: 0.0006916427, nomconc: 203.2

#4. to cellular concentration being X-fold higher than nominal (chemical)
max(combodata$RMSLE_nominal_by_chem) #3.130213 (Chlorpromazine) - cell conc: 4558.731, nomconc: 20

combodata %>% arrange(RMSLE_nominal_by_chem) %>% select(ChemicalName.x, Citation.x, nomconc, CellConcentration_uM.x, RMSLE_nominal_by_chem)

```

## Change in Accuracy of Intracellular Concentration predicted by studies reporting experimentally measured nominal dose
```{r}

unique(IVD_Manuscript_data %>% dplyr::filter(is.na(ExperimentalDose_uM)) %>% select(Citation))
#8 citations did not measure experimental dose at all
#121 observations

IVD_Manuscript_data %>% dplyr::filter(!(is.na(ExperimentalDose_uM))) %>% select(Citation, nomconc, NominalDose_uM, ExperimentalDose_uM)
unique(IVD_Manuscript_data %>% dplyr::filter(!(is.na(ExperimentalDose_uM))) %>% select(Citation))
#6 citations did measure experimental dose
#42 observations

exp_nom.dt<-copy(IVD_Manuscript_data[!(is.na(ExperimentalDose_uM)),]) #42 entries
#unique(exp_nom.dt$Citation) #6 citations

#run armitage with nomconc as NominalDose_uM.x
arm_nomconc<-copy(exp_nom.dt[, nomconc := NominalDose_uM])

# run Armitage model, output concentrations in umol/L (e.g. uM)
armitageOutput_arm_nomconc <- armitage_eval(tcdata=arm_nomconc, 
                                            surface.area.switch = TRUE,
                                       user_assay_parameters = user_assay_parameters,
                                        restrict.ion.partitioning = TRUE)

#run armitage with nomconc as ExperimentalDose_uM.x
arm_expconc<-copy(exp_nom.dt[, nomconc := ExperimentalDose_uM])

armitageOutput_arm_expconc <- armitage_eval(tcdata=arm_expconc, 
                                            surface.area.switch = TRUE,
                                       user_assay_parameters = user_assay_parameters,
                                        restrict.ion.partitioning = TRUE)

#Armitage NOMCONC RMSLE:
arm_nomconc_rmsle_long<-rmsle((armitageOutput_arm_nomconc$CellConcentration_uM),(armitageOutput_arm_nomconc$ccells))
arm_nomconc_rmsle<-round(arm_nomconc_rmsle_long, 2)
#1.62

#Armitage EXPCONC RMSLE:
arm_expconc_rmsle_long<-rmsle((armitageOutput_arm_expconc$CellConcentration_uM),(armitageOutput_arm_expconc$ccells))
arm_expconc_rmsle<-round(arm_expconc_rmsle_long, 2)
#1.53

#improvement between the experimental and nomconc rmsles
arm_nomconc_rmsle- arm_expconc_rmsle
#0.09

# plots are not visually interesting so not including

```

#Supplement:

## Table S1. Physicochemical properties of test chemicals and Ccell/Cnominal ratios from each reference.
```{r}

#create datatable to hold the info
table1.dt<-copy(Nominal.dt)

# format for viewing pleasure
data.dt<-table1.dt[, c("Citation", "casrn", "ChemicalName", "IOC_Type", "nomconc", "CellConcentration_uM"), with = FALSE] #subset columns


# pull dtxsids, log P, henry's law, and pka:

#dtxsids
cheminfo.dt<-as.data.table(get_chem_id(chem.cas=unique(data.dt$casrn)))

cheminfo.dt[, casrn:=chem.cas] %>% #rename
  .[,chem.cas:=NULL] %>% #delete column
  .[,chem.name:=NULL] #delete column

#add dtxsid info to the storage file
data.dt2<-data.dt[cheminfo.dt,on="casrn"]

#collect log P, henry's law, and pka values
data.dt2[, c("logP","logHenry", "pKa_Donor", "pKa_Accept") := as.data.frame(get_physchem_param(param = c("logP","logHenry", "pKa_Donor", "pKa_Accept"), chem.cas = casrn))] 


# calculate median CellConcentration_uM:cnom ratio (for each citation if multiple) and number of observations per chemical

#get ccell : cnom ratio
data.dt2[,cellconc_cnom_ratio:=CellConcentration_uM/nomconc]

#for each chemical and citation combination, calculate the median ccell:cnom ratio
data.dt2[, median_ratio := median(cellconc_cnom_ratio), by=list(Citation, ChemicalName)]

#count the number of observations by citation and chemname
data.dt2[, number_of_obs:=.N, by=list(Citation, ChemicalName)]

#filter down to one observation per citation/casrn combo
final_output<-data.dt2 %>% 
  mutate(logP=round(logP, 2),
         logHenry=round(logHenry, 2),
         median_ratio=round(median_ratio, 3),
         pKa = paste(pKa_Accept, pKa_Donor, sep=",")) %>% 
  select(-c("casrn", "nomconc", "CellConcentration_uM", "cellconc_cnom_ratio", "pKa_Donor", "pKa_Accept")) %>% #get rid of extra rows
  distinct(Citation, ChemicalName, .keep_all = TRUE) #filter 

#save the output
if(save_output){
  write.csv(final_output, file = paste0(path_out,"table_s1_",data.date,"_",Sys.Date(),".csv"))
}

```

## Table S2. In vitro assay descriptors for the measurements

```{r assay_descriptors_table, eval = execute.vignette}

#copy table to manipulate
parameter_table<-copy(Nominal.dt)

table_s2<-parameter_table[, c("Citation", "ChemicalName", "nomconc", "NominalDose_uM", "v_total", "v_working", "sarea", "well_number", "cell_yield", "FBSf", "FigureNumber", "CellType")] #subset columns

#save the output
if(save_output){
  write.csv(table_s2, 
            file = paste0(path_out,"table_s2_raw_",data.date,"_",Sys.Date(),".csv"))
}

```

## Table S3. Root mean squared log error (RMSLE) and coefficient of determination (r2) for the chemicals with multiple observations. Note: Atrazine, Flusilazole, N-Phenyl-1,4-benzenediamine, Rosiglitazone, Thiacloprid, and Triphenyl phosphate each only reflect two data points.
```{r multobs_RMSLE_table, eval = execute.vignette}

#Armitage
multobs_rmsle_armitage<-NULL
for (chemical.option in unique(Armitage.multobs.dt$ChemicalName)){
  
  #isolate the data
  Chemical_DataList <- Armitage.multobs.dt %>% dplyr::filter(ChemicalName == chemical.option)

  #RMSLE
  #armitage
  RMSLE_armitage_mult <- rmsle((Chemical_DataList$mean_measuredccell), (Chemical_DataList$mean_predictedccell))
  
  #r squared
  #armitage
  ml = lm(mean_measuredccell~mean_predictedccell, data = Chemical_DataList)
  rsq_armitage_mult <- summary(ml)$r.squared 
  
  numberofpoints<-length(Chemical_DataList$ChemicalName)
  
  #create row
  current_row<- c(chemical.option, 
                  round(RMSLE_armitage_mult, 2),
                  round(rsq_armitage_mult, 2), 
                  numberofpoints)
  
  #append row
  multobs_rmsle_armitage <- rbind(multobs_rmsle_armitage, current_row) 
  
}
#numberofpoints = number of datapoints considered (includes averaged points)


#run again for kramer
multobs_rmsle_kramer<-NULL
for (chemical.option in unique(Kramer.multobs.dt$ChemicalName)){
  
  #isolate the data
  Chemical_DataList <- Kramer.multobs.dt %>% dplyr::filter(ChemicalName == chemical.option)

  #RMSLE
  #kramer
  RMSLE_kramer_mult <- rmsle((Chemical_DataList$mean_measuredccell), (Chemical_DataList$mean_predictedccell))
  
    #r squared
  #kramer
  ml = lm(mean_measuredccell~mean_predictedccell, data = Chemical_DataList)
  rsq_kramer_mult <- summary(ml)$r.squared 
  
  numberofpoints<-length(Chemical_DataList$ChemicalName)
  
  #create row
  current_row<- c(chemical.option, 
                  round(RMSLE_kramer_mult, 2),
                  round(rsq_kramer_mult, 2),
                  numberofpoints)
  
  #append row
  multobs_rmsle_kramer <- rbind(multobs_rmsle_kramer, current_row) 
  
}

print(multobs_rmsle_armitage)
print(multobs_rmsle_kramer)

multobs_rmsle_armitage.dt<-as.data.table(multobs_rmsle_armitage)
filt_multobs_rmsle_armitage.dt<-copy(multobs_rmsle_armitage.dt[, Name := V1] %>% 
  .[,RMSLE_arm := V2] %>% 
  .[,r2_arm := V3] %>% 
    .[,NumberofPts := V4] %>% 
  .[, c("Name", "RMSLE_arm", "r2_arm", "NumberofPts")])

multobs_rmsle_kramer.dt<-as.data.table(multobs_rmsle_kramer)
filt_multobs_rmsle_kramer.dt<-copy(multobs_rmsle_kramer.dt[, Name := V1] %>% 
  .[,RMSLE_kram := V2] %>% 
  .[,r2_kram := V3] %>% 
    .[,NumberofPts := V4] %>% 
  .[, c("Name", "RMSLE_kram", "r2_kram", "NumberofPts")])


mult.dt<-merge(filt_multobs_rmsle_kramer.dt, filt_multobs_rmsle_armitage.dt)

#for higher/lower rmsle comparison
mult_HL<-copy(mult.dt[RMSLE_kram>RMSLE_arm, higherorlower:="Kramer higher"] %>% 
  .[RMSLE_kram<RMSLE_arm, higherorlower:="kramer lower"]) %>% 
  .[, magnitude := as.numeric(RMSLE_kram)-as.numeric(RMSLE_arm)]

mult_HL %>% count(higherorlower)

#save the output
if(save_output){
  write.csv(mult.dt, 
            file = paste0(path_out,"table_s3_",data.date,"_",Sys.Date(),".csv"))
}



```
## Table S4: RMSLE and r^2 for acids and bases.
```{r ionization_RMSLE_table, eval = execute.vignette}

##create datatable with both outputs stacked 
stacked.data<-rbind(Armitage.dt, Kramer.dt, fill=TRUE)


ionization_rmsle<-NULL

for (modelType in unique(stacked.data$label)){
  
  ionization.df<- stacked.data[label == modelType,]
  
  if (modelType == "Armitage"){
    
    for (ionization_option in unique(ionization.df$IOC_Type)){
      
      #isolate the data
      ionization_optionDataList <- ionization.df %>% dplyr::filter(IOC_Type == ionization_option)
      
      #RMSLE armitage
      RMSLE_armitage_ionization <- rmsle((ionization_optionDataList$CellConcentration_uM), (ionization_optionDataList$ccells))
  

      #r squared armitage
      ml = lm(CellConcentration_uM~ccells, data = ionization_optionDataList)
      rsq_armitage_ionization <- summary(ml)$r.squared 

  
      #create row
      current_row<- c(modelType,
                      ionization_option, 
                  round(RMSLE_armitage_ionization, 2),
                  round(rsq_armitage_ionization, 2))

  
      #append row
      ionization_rmsle <- rbind(ionization_rmsle, current_row)
    
    }
    
  }
  
  if (modelType == "Kramer"){
    
    for (ionization_option in unique(ionization.df$IOC_Type)){
      
      #isolate the data
      ionization_optionDataList <- ionization.df %>% dplyr::filter(IOC_Type == ionization_option)
      
      #RMSLE kramer
      RMSLE_kramer_ionization <- rmsle((ionization_optionDataList$CellConcentration_uM), (ionization_optionDataList$concentration_cells))
  

      #r squared kramer
      ml = lm(CellConcentration_uM~concentration_cells, data = ionization_optionDataList)
      rsq_kramer_ionization <- summary(ml)$r.squared 

  
      #create row
      current_row<- c(modelType,
                  ionization_option, 
                  round(RMSLE_kramer_ionization, 2),
                  round(rsq_kramer_ionization, 2))

  
      #append row
      ionization_rmsle <- rbind(ionization_rmsle, current_row)
    
    }
    
    
  }
  
}

print(ionization_rmsle)

#save the output
if(save_output){
  write.csv(ionization_rmsle, 
            file = paste0(path_out,"table_s4_",data.date,"_",Sys.Date(),".csv"))
}


```

## Table S5. RMSLE across lipophilicity.
```{r logP_RMSLE_table, eval = execute.vignette}

#cut up into chunks
gkowbins<-stacked.data %>% mutate(LogP_bins = cut(gkow, breaks = c(-Inf, 1.30, 3.36, Inf),
  labels = c("Hydrophilic", "Moderate Lipophilic", "Lipophilic")))

#Armitage:
gkowbins_armitage<- gkowbins[label == "Armitage",]
rmsle_gkow_armitage<-gkowbins_armitage[, .(Armitage_RMSLE=rmsle(CellConcentration_uM, ccells)), by = LogP_bins]

#Kramer:
gkowbins_kramer<- gkowbins[label == "Kramer",]
rmsle_gkow_kramer<-gkowbins_kramer[, .(Kramer_RMSLE=rmsle(CellConcentration_uM, concentration_cells)), by = LogP_bins]

gkow_output<-merge(rmsle_gkow_armitage, rmsle_gkow_kramer)

#save the output
if(save_output){
  write.csv(gkow_output, 
            file = paste0(path_out,"table_s5_",data.date,"_",Sys.Date(),".csv"))
}

```

## Table S6. RMSLE across volatility.
```{r kaw_RMSLE_table, eval = execute.vignette}

#source for chunks is table 2 Volatility class in water: https://www.epa.gov/pesticide-science-and-assessing-pesticide-risks/guidance-reporting-environmental-fate-and-transport#:~:text=is%20very%20low.-,Volatility%20from%20Water,the%20reciprocal%20of%20KAW.&text=GMW%20=%20gram%20molecular%20weight%20in%20g/mole.&text=This%20value%20is%20the%20inverse,as%20Cwater/Cair.&text=Note%20that%20all%20chemicals%20may,volatility%20potential%20is%20very%20low.

#cut up kaw into relevant bins
kawbins<-stacked.data %>% mutate(Kaw_bins = cut(DR_kaw, breaks = c(Inf, 10^-2, 10^-3, 10^-5, -Inf),
  labels = c("Rapidly lost from a water surface", "Volatile from a water surface", "Slightly volatile from a water surface", "Non-volatile")))

#Armitage:
kawbins_armitage<- kawbins[label == "Armitage",]
rmsle_kaw_armitage<-kawbins_armitage[, .(Armitage_RMSLE=rmsle(CellConcentration_uM, ccells)), by = Kaw_bins] 

kawbins_armitage %>% group_by(Kaw_bins) %>% distinct(ChemicalName) %>%  count()

#Kramer:
kawbins_kramer<- kawbins[label == "Kramer",]
rmsle_kawbins_kramer<-kawbins_kramer[, .(Kramer_RMSLE=rmsle(CellConcentration_uM, concentration_cells)), by = Kaw_bins]

kaw_output<-merge(rmsle_kawbins_kramer, rmsle_kaw_armitage)

#save the output
if(save_output){
  write.csv(kaw_output, 
            file = paste0(path_out,"table_s6_",data.date,"_",Sys.Date(),".csv"))
}


```

## Table S7. Effect of "options" on rmsle in the Armitage model.
```{r options_plot}


#list of options that can be changed in the armitage model:

# 		- this.option.kbsa2 Use alternative bovine-serum-albumin partitioning
# 		- this.option.swat2 Use alternative water solubility correction
# 		- this.option.kpl2 Use alternative plastic-water partitioning model
# 		- option.plastic == TRUE (default) gives nonzero surface area
# 		- option.bottom == TRUE (default) includes surface area of the bottom of the well in determining sarea
# 		- restrict.ion.partitioning 
# 			§ False (default):  Treat entire chemical as neutral and allow it all to partition normally as such
# 			§ True: Restrict so only the neutral fraction of the chemical is available to partition normally but the ionized portion is scaled


##filter to just the ones we can run with the surface area calculation since option.plastic and option.bottom require that function:
options.IVD_Manuscript_data<-options.IVD_Manuscript_data[!is.na(well_number), ] %>% 
  .[,sarea:=NULL]  #delete sarea so the surface area function will run 
#136 out of the original 163 observations

# create table to append the results to 
options.table <- NULL

# run basic armitage, only setting the surface area switch
option.basic <- armitage_eval(tcdata=options.IVD_Manuscript_data,
                              surface.area.switch = TRUE,
                              user_assay_parameters = user_assay_parameters)

option.basic_RMSLE<-rmsle((option.basic$CellConcentration_uM),(option.basic$ccells))
#2.113451

#append to table
options.table<-rbind(options.table, c(round(option.basic_RMSLE ,3), "All Default"))

# run with this.option.kbsa2 == TRUE (default is false)
option.kbsa <- armitage_eval(tcdata=options.IVD_Manuscript_data,
                             this.option.kbsa2 = TRUE,
                             surface.area.switch = TRUE,
                             user_assay_parameters = user_assay_parameters)

option.kbsa_RMSLE<-rmsle((option.kbsa$CellConcentration_uM),(option.kbsa$ccells))
#2.087882

#append to table
options.table<-rbind(options.table, c(round(option.kbsa_RMSLE, 3), "option.kbsa=TRUE"))


# run with this.option.swat2 == TRUE (default is false)
option.swat <- armitage_eval(tcdata=options.IVD_Manuscript_data,
                             this.option.swat2 = TRUE,
                             surface.area.switch = TRUE,
                             user_assay_parameters = user_assay_parameters)

option.swat_RMSLE<-rmsle((option.swat$CellConcentration_uM),(option.swat$ccells))
#3.214113

#append to table
options.table<-rbind(options.table, c(round(option.swat_RMSLE, 3), "option.swat2=TRUE"))

# run with this.option.kpl2 == TRUE (Fischer) (default is false/kramer)
option.kpl <- armitage_eval(tcdata=options.IVD_Manuscript_data,
                             this.option.kpl2 = TRUE,
                            surface.area.switch = TRUE,
                            user_assay_parameters = user_assay_parameters)

option.kpl_RMSLE<-rmsle((option.kpl$CellConcentration_uM),(option.kpl$ccells))
#2.042262

#append to table
options.table<-rbind(options.table, c(round(option.kpl_RMSLE, 3), "option.kpl2=TRUE"))

# run with option.plastic == FALSE (default is true)
opt.plast_input<- copy(options.IVD_Manuscript_data)
opt.plast_input[,option.plastic := FALSE]

option.plast <- armitage_eval(tcdata=opt.plast_input,
                              surface.area.switch = TRUE,
                              user_assay_parameters = user_assay_parameters)

option.plast_RMSLE<-rmsle((option.plast$CellConcentration_uM),(option.plast$ccells))
#2.130671

#append to table
options.table<-rbind(options.table, c(round(option.plast_RMSLE, 3), "option.plastic=FALSE"))

# run with option.bottom == FALSE (default is true)
option.bottom_input<- copy(options.IVD_Manuscript_data)
option.bottom_input[,option.bottom := FALSE]

option.bottom <- armitage_eval(tcdata=option.bottom_input,
                               surface.area.switch = TRUE,
                              user_assay_parameters = user_assay_parameters)

option.bottom_RMSLE<-rmsle((option.bottom$CellConcentration_uM),(option.bottom$ccells))
#2.117772

#append to table
options.table<-rbind(options.table, c(round(option.bottom_RMSLE,3), "option.bottom=FALSE"))

# run with restrict.ion.partitioning == TRUE (default is FALSE)
option.restion <- armitage_eval(tcdata=options.IVD_Manuscript_data,
                             restrict.ion.partitioning = TRUE,
                             surface.area.switch = TRUE,
                              user_assay_parameters = user_assay_parameters)

option.restion_RMSLE<-rmsle((option.restion$CellConcentration_uM),(option.restion$ccells))
#2.10899

#append to table
options.table<-rbind(options.table, c(round(option.restion_RMSLE,3), "restrict.ion.partitioning = TRUE"))


```


## Figure S1. Histogram showing chemical-specific RMSLE for Armitage Ccell vs Measured Ccell and Kramer Ccell vs Measured Ccell:
```{r intracellular_histogram_plot, eval = execute.vignette}

#calculate RMSLE for each row of data
combodata[, RMSLE_armitage_by_chem:= rmsle(CellConcentration_uM.x, ccells), by = "ChemicalName.x"]
combodata[, RMSLE_kramer_by_chem:= rmsle(CellConcentration_uM.x, concentration_cells), by = "ChemicalName.x"]
#combodata[, RMSLE_nominal_by_chem:= rmsle(CellConcentration_uM.x, nomconc), by = "ChemicalName.x"]

#cut down to one observation per chemical
histo.data<-copy(combodata %>% 
                   select(ChemicalName.x, RMSLE_armitage_by_chem, RMSLE_kramer_by_chem, RMSLE_nominal_by_chem) %>% 
                   unique())

#option to set binwidth:
#bw <- 2 * IQR(combodata$RMSLE_nominal) / length(combodata$RMSLE_nominal)^(1/3)

#plot histograms
nominal_histogram_by_chem <-ggplot(histo.data, aes(x=RMSLE_nominal_by_chem)) + 
  geom_histogram(binwidth = 0.5, boundary = 0) +
  labs(x = "Nominal RMSLE",
       y = "Count") + 
  xlim(0, 5) + ylim(0, 17) +
  theme_classic() +  
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14))

armitage_histogram_by_chem <-ggplot(histo.data, aes(x=RMSLE_armitage_by_chem)) + 
  geom_histogram(binwidth = 0.5, boundary = 0) +
  labs(x = "Armitage RMSLE",
       y = "Count") +
  xlim(0, 5) + ylim(0, 17) +
  theme_classic() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14))

kramer_histogram_by_chem <- ggplot(histo.data, aes(x=RMSLE_kramer_by_chem)) + 
  geom_histogram(binwidth = 0.5, boundary = 0) +
  labs(x = "Kramer RMSLE",
       y = "Count") +
  xlim(0, 5) + ylim(0, 17) +
  theme_classic()+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14))

histogram_comboplot_by_chem<-ggarrange(nominal_histogram_by_chem, armitage_histogram_by_chem, kramer_histogram_by_chem, ncol=3)

if(save_output){
  ggsave(file = paste0("Figure_S1_by_chem_",data.date,"_",Sys.Date(),".png"),
         path = path_out,
         histogram_comboplot_by_chem, width = 10, height = 5, dpi = 300)
}


print(histogram_comboplot_by_chem)

#combodata %>% arrange(RMSLE_nominal_by_chem) %>% select(ChemicalName.x, nomconc, CellConcentration_uM.x, RMSLE_nominal_by_chem)


```
