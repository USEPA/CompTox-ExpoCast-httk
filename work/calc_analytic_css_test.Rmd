---
title: "Testing calc_analytic_css"
author: "Caroline Ring"
date: "5/2/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
devtools::load_all(path = "../httk")
```

`calc_analytic_css()` is acting weird with model `3compartmentss` and restrictive/nonrestrictive clearance.

Let's take one example chemical.

```{r, results='markup'}
knitr::kable(chem.physical_and_invitro.data[chem.physical_and_invitro.data$CAS %in% "100-02-7",
                               c("CAS",
                                 "Compound",
                                 "Human.Clint",
                                 "Human.Funbound.plasma")])
```


Observe:

If we call `calc_analytic_css(model = "3compartmentss")`, we get one answer for steady-state plasma concentrartion:

```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "3compartmentss",
                                   restrictive.clearance = TRUE))
```

But if we call `calc_analytic_css_3compss()` directly, we get a different, greater steady-state concentration. This is the opposite of what I would expected with non-restrictive clearance -- clearance should be faster.

```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "3compartmentss",
                                   restrictive.clearance = FALSE))
```

Should it not be the other way around? If we use a different model (say 3-compartment), it behaves more as expected.

Here is 3-comaprtment model with restrictive clearance. The answer is very close to that of the 3-comaprtment steady-state model, as expected.

```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "3compartment",
                                   restrictive.clearance = TRUE))
```

With non-restrictive clearance and the 3-compartment model, we now get a lower steady-state plasma concentration. This is what I would expect with non-restrictive clearance, which ought to be faster, right?
```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "3compartment",
                                   restrictive.clearance = FALSE))
```

With the PBTK model we get a slightly different steady-state plasma concentration (compared to 3-compartment and 3-compartment steady state) with restrictive clearance turned on:

```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "pbtk",
                                   restrictive.clearance = TRUE))
```

But we again get a still lower steady-state plasma concentration with non-restrictive clearance, as expected:
```{r}
suppressWarnings(calc_analytic_css(chem.cas = "100-02-7",
                                   model = "pbtk",
                                   restrictive.clearance = FALSE))
```

I think this comes down to line 124 in `calc_analytic_css_3compss()`, which reads:

```{r, eval = FALSE}
 if (!restrictive.clearance) cl <- cl*Fup
```

Should this not be the other way around, like the following? That is how it is in all the other model-specific `calc_analytic_css` functions.

```{r, eval = FALSE}
if (!restrictive.clearance) cl <- cl/Fup
```

I'm also mildly concerned that in `calc_analytic_css()`, line 205 already corrects for non-restrictive clearance before calling the model-specific `calc_analytic_css_...` function:

```{r, eval = FALSE}
  if (!restrictive.clearance) parameters$Clmetabolismc <- 
    parameters$Clmetabolismc / parameters$Funbound.plasma
```

and then it seems to get done a second time in the model-specific `calc_analytic_css_...` functions, like `calc_analytic_pbtk()`. Am I missing something? It seems like the non-restrictive clearance assumption should be handled only in one place, not both. It shouldn't affect the results for restrictive clearance (which is the default), but it seems like it will boost unrestricted clearance way too much (unless Fup is 1).

