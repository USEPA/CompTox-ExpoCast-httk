---
title: "Weird Css behavior for two CASRNs"
author: "Caroline Ring"
date: "5/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
devtools::load_all(path = "../httk")
```

```{r}
library(ggplot2)
out_path <- "C:/Users/cring/OneDrive - Environmental Protection Agency (EPA)/httk/gfr_changes_output/"
```

# The problem

When I ran `calc_mc_css()` for all chemicals for which the 3-comaprtment steady-state model can be parameterized, I noticed that two chemicals have zero or near-zero for all percentiles of Css. 

These are their CAS numbers:

```{r}
weird_cas <- c("129453-61-8",
               "103-24-2")
```

Here is their chemical info:

```{r}
tmp <- get_cheminfo(info = c("CAS", "Compound", "Clint", "Clint.pValue", "Funbound.plasma"))
tmp[tmp$CAS %in% c("103-24-2", "129453-61-8"), ]
```


## What happens when I run calc_mc_css

```{r}
calc_mc_css(chem.cas = "103-24-2", suppress.messages = TRUE, which.quantile = c(0.05,0.25,0.5,0.75,0.95))
```

```{r}
calc_mc_css(chem.cas = "129453-61-8", suppress.messages = TRUE, which.quantile = c(0.05,0.25,0.5,0.75,0.95))
```

## What happens when I run calc_analytic_css

```{r}
calc_analytic_css(chem.cas = "103-24-2", suppress.messages = TRUE)
```

Small but non zero.

```{r}
calc_analytic_css(chem.cas = "129453-61-8", suppress.messages = TRUE)
```

Not small at all!!

What the heck is going on?

## Weirdness with Clint distribution in parameterize_steadystate

For CASRN "129453-61-8" (Fulvestrant), I noticed anotehr weird thing. Pay attention to `Clint.dist`.

```{r}
as.data.frame(parameterize_steadystate(chem.cas = "129453-61-8"))
```


`Clint.dist` is 2.4, 0, 3.98, 0.105.

But when I used `get_cheminfo`, I saw a very different Clint distribution?

```{r}
tmp[tmp$CAS %in% "129453-61-8", ]
```

From `get_cheminfo()`, the Clint distribution is 0,0,0,0.105. 

What in the world is going on here?

John wambaugh notes that the p-value is greater than 0.05, so that makes the Clint get set to 0. But somehow that seems to do different things in `calc_mc_css` vs. `calc_analytic_css`. Is a p-value argument not getting passed somewhere or something? [per discussion at ExpoCast CETB Team meeting on May 3, 2022, 10 AM]

It looks like `parameterize_steadystate()` calls `get_invitroPK_param()` to get Clint. What does that function return?

```{r}
get_invitroPK_param(
"Clint",
species = "Human",
chem.cas="129453-61-8")

```


Hmmmmmm. OK, that returns something different. Where is that function pulling that info from, if not `chem.physical_and_invitro_data`?

OK, that does pull from `chem.physical_and_innvitro.data`.

```{r}
chem.physical_and_invitro.data[chem.physical_and_invitro.data$CAS == "129453-61-8", "Human.Clint"]
```

Then....what is `get_cheminfo()` doing???

What happens with `parameterize_steadystate` on the other chemical?

```{r}
parameterize_steadystate(chem.cas = "103-24-2")
```

For this one, it returns Clint of 392600, rather than the `get_cheminfo` value of 3.52. 

John says this has to do with the `Fhep.assay.correction` parameter which in turn has to do with `logDow74`. Basically, the Log Dow value is so extreme that it breaks the assay binding correction model. But I pointed out that this still acts *differently* between `calc_analytic_css` and `calc_mc_css` -- even if that model breaks, it ough to break the same way between both functions!

# Braoder comparison between calc_mc_css and calc_analytic_css

I ran `calc_mc_css` for all the chemicals for which the 3-compartment steady state can be parameterized in the course of testing the CKD-EPI equation changes.  Let me just re-load that saved file rathe rhtan re-running everything.

```{r}
css_list_old <- readRDS(paste0(out_path,
               "css_list_old.Rds"))
css_list_old <- as.data.frame(css_list_old)

```

Let me run `calc_analytic_css` for all of these chemicals, and add the answer as a column to the data.frame.

```{r}
foo <- sapply(rownames(css_list_old),
                                    function(x) {
                                      tryCatch(suppressWarnings(calc_analytic_css(chem.cas = x,
                                                                                  model = "3compartmentss",
                                                                         suppress.messages = TRUE)),
                                               error = function(err) NA_real_)
                                    },
                                    USE.NAMES = FALSE
)
css_list_old$css_analytic <- foo
```

```{r}

ggplot(css_list_old) +
  geom_point(aes(x = `50%`,
                 y = css_analytic)) +
  geom_abline(intercept=0, slope =1) +
  xlab("calc_mc_css() 50th percentile") +
  ylab("calc_analytic_css() result") +
  scale_x_log10(oob = scales::squish_infinite) + 
  scale_y_log10(oob = scales::squish_infinite) +
  geom_abline(intercept=1, slope = 1, linetype = 2) +
  geom_abline(intercept = -1, slope = 1, linetype = 2) +
  geom_abline(intercept=2, slope = 1, linetype = 3) +
  geom_abline(intercept = -2, slope = 1, linetype = 3) +
  annotation_logticks()
```

The dashed lines show a factor of 10 different; the dotted lines show a factor of 100 different.

There are a few chemicals where the analytic Css is more than a factor of 100 greater than the Monte Carlo 50th percentile Css. And the three points on a vertical line to the far left of the plot? Those are the ones where the Monte Carlo 50th percentile Css is zero, or close to it.

```{r}
css_list_old[css_list_old[["50%"]]<1e-5, ]
```


Color code by Clint and Funbound.plasma? First need to get these quantities using `parameterize_steadystate`

```{r}
foo2 <- lapply(rownames(css_list_old), function(x) suppressWarnings(parameterize_steadystate(chem.cas = x, suppress.messages = TRUE)))
foo2 <- lapply(foo2, as.data.frame)
foo2_df <- do.call("rbind", foo2)
newcols <- names(foo2[[1]]) #columns to be added
css_list_old[newcols] <- foo2_df

rm(foo2_df, foo2, foo)
```


```{r}

ggplot(css_list_old) +
  geom_point(aes(x = `50%`,
                 y = css_analytic,
                 color = Clint)) +
  geom_abline(intercept=0, slope =1) +
  xlab("calc_mc_css() 50th percentile") +
  ylab("calc_analytic_css() result") +
  scale_x_log10(oob = scales::squish_infinite) + 
  scale_y_log10(oob = scales::squish_infinite) +
  geom_abline(intercept=1, slope = 1, linetype = 2) +
  geom_abline(intercept = -1, slope = 1, linetype = 2) +
  geom_abline(intercept=2, slope = 1, linetype = 3) +
  geom_abline(intercept = -2, slope = 1, linetype = 3) +
  annotation_logticks() +
  scale_color_viridis_c(trans = "log10",
                        option = "plasma")
```

```{r}
ggplot(css_list_old) +
  geom_point(aes(x = `50%`,
                 y = css_analytic,
                 color = Funbound.plasma)) +
  geom_abline(intercept=0, slope =1) +
  xlab("calc_mc_css() 50th percentile") +
  ylab("calc_analytic_css() result") +
  scale_x_log10(oob = scales::squish_infinite) + 
  scale_y_log10(oob = scales::squish_infinite) +
  geom_abline(intercept=1, slope = 1, linetype = 2) +
  geom_abline(intercept = -1, slope = 1, linetype = 2) +
  geom_abline(intercept=2, slope = 1, linetype = 3) +
  geom_abline(intercept = -2, slope = 1, linetype = 3) +
  annotation_logticks() +
  scale_color_viridis_c(trans = "log10",
                        option = "magma")
```

Most of the ones outside the factor-100 lines have Funbonud.plasma of 1e-4. But no all (there are a couple in the middle that don't), and there are plenty of chemicals *within* the factor-100 lines -- and even within the factor-10 lines -- with Funbound.plasma of 1e-4.

```{r}
ggplot(css_list_old) +
  geom_point(aes(x = `50%`,
                 y = css_analytic,
                 color = Dow74)) +
  geom_abline(intercept=0, slope =1) +
  xlab("calc_mc_css() 50th percentile") +
  ylab("calc_analytic_css() result") +
  scale_x_log10(oob = scales::squish_infinite) + 
  scale_y_log10(oob = scales::squish_infinite) +
  geom_abline(intercept=1, slope = 1, linetype = 2) +
  geom_abline(intercept = -1, slope = 1, linetype = 2) +
  geom_abline(intercept=2, slope = 1, linetype = 3) +
  geom_abline(intercept = -2, slope = 1, linetype = 3) +
  annotation_logticks() +
  scale_color_viridis_c(trans = "log10",
                        option = "magma")
```

```{r}
ggplot(css_list_old) +
  geom_point(aes(x = `50%`,
                 y = css_analytic,
                 color = Fhep.assay.correction)) +
  geom_abline(intercept=0, slope =1) +
  xlab("calc_mc_css() 50th percentile") +
  ylab("calc_analytic_css() result") +
  scale_x_log10(oob = scales::squish_infinite) + 
  scale_y_log10(oob = scales::squish_infinite) +
  geom_abline(intercept=1, slope = 1, linetype = 2) +
  geom_abline(intercept = -1, slope = 1, linetype = 2) +
  geom_abline(intercept=2, slope = 1, linetype = 3) +
  geom_abline(intercept = -2, slope = 1, linetype = 3) +
  annotation_logticks() +
  scale_color_viridis_c(trans = "log10",
                        option = "magma")
```

